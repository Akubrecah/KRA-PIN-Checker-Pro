<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRA PIN Checker Pro | AkubrecaH</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        tailwind.config = {
            prefix: 'tw-',
            corePlugins: {
                preflight: false,
            }
        }
    </script>
    <style>
        /* Standalone PDF Generator Styles */
        :root {
            --kra-red: #ff0000;
            --kra-black: #000000;
            --kra-grey: #f3f4f6;
        }

        /* Certificate Layout */
        #certificate-container {
            width: 210mm;
            height: 297mm;
            max-height: 297mm; /* Strict height limit */
            overflow: hidden; /* Prevent spillover */
            background: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            transform: scale(0.6); /* Scaled down for preview */
            transform-origin: top left;
        }

        #print-area {
            padding: 2.5cm;
            color: black;
            flex: 1;
            display: flex;
            flex-direction: column;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .cert-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid black;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .cert-logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cert-logo-section img {
            height: 60px;
        }

        .kra-text {
            font-weight: 900;
            font-size: 16px;
            line-height: 1.1;
            color: black;
        }

        .cert-label {
            background: #e5e7eb;
            padding: 10px 40px;
            font-weight: 900;
            font-size: 20px;
            border: 1px solid #d1d5db;
        }

        .cert-contact-info {
            text-align: right;
            font-size: 9px;
            line-height: 1.4;
        }

        .date-pin-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .date-pin-box {
            text-align: right;
            line-height: 1.5;
        }

        .cert-date {
            font-size: 11px;
        }

        .pin-label {
            font-weight: 700;
            font-size: 12px;
            margin-top: 5px;
        }

        .pin-value {
            font-weight: 500;
            font-size: 11px;
        }

        .intro-text {
            text-align: center;
            font-size: 11px;
            margin-bottom: 20px;
        }

        .section-title {
            text-align: center;
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 10px;
            text-transform: capitalize;
        }

        .cert-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 11px;
        }

        .cert-table, .cert-table th, .cert-table td {
            border: 1px solid black;
        }

        .cert-table th, .cert-table td {
            padding: 3px 6px;
            text-align: left;
        }

        .obligation-table th, .obligation-table td {
            text-align: center;
            vertical-align: middle;
            font-size: 9px; /* Smaller font to fit data */
            padding: 2px 4px; /* Tighter padding */
            white-space: nowrap; /* Prevent wrapping implies scaling or fitting */
        }

        .obligation-table thead th {
            font-weight: 700;
        }
        .bg-grey {
            /* background-color: #f9fafb; Removed fill */
            font-weight: 700;
            width: 30%;
        }


        .footer-text {
            font-size: 10px;
            line-height: 1.5;
            margin-top: auto;
            padding-top: 20px;
        }

        .disclaimer {
            border-top: 1px solid black;
            padding-top: 5px;
            margin-top: 30px;
            font-weight: 700;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>PIN Checker Pro 2026</h1>
            <p class="subtitle">Official KRA Integrated Verification Suite</p>
        </header>

        <div class="tabs">
            <div class="tab active" id="tabID" onclick="switchTab('ID')">Verify by ID</div>
            <div class="tab" id="tabPIN" onclick="switchTab('PIN')">Verify by PIN</div>
        </div>

        <!-- Form 1: Verify by ID -->
        <form id="checkerFormID" class="checker-form">
            <div class="form-group">
                <label for="taxpayerType">Taxpayer Type</label>
                <select id="taxpayerType" required>
                    <option value="KE">Kenyan Resident (KE)</option>
                    <option value="NKE">Non-Kenyan Resident (NKE)</option>
                    <option value="NKENR">Non-Kenyan Non-Resident (NKENR)</option>
                    <option value="COMP">Non-Individual/Company (COMP)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="taxpayerID">Taxpayer ID / National ID</label>
                <input type="text" id="taxpayerID" placeholder="Enter ID number" required>
            </div>

            <button type="submit" id="submitBtnID">
                <span id="btnTextID">Verify Identity</span>
                <div class="loader" id="loaderID"></div>
            </button>
        </form>

        <!-- Form 2: Verify by PIN -->
        <form id="checkerFormPIN" class="checker-form" style="display: none;">
            <div class="form-group">
                <label for="kraPIN">KRA PIN</label>
                <input type="text" id="kraPIN" placeholder="e.g. P318295670X" required pattern="^[AP][0-9]{9}[A-Z]$" title="Starts with A or P, 9 digits, ends with a letter">
            </div>

            <button type="submit" id="submitBtnPIN">
                <span id="btnTextPIN">Check PIN Status</span>
                <div class="loader" id="loaderPIN"></div>
            </button>
        </form>

        <div id="errorArea" class="error-message"></div>

        <div id="resultsArea" class="results-area">
            <div class="result-card">
                <div class="result-item">
                    <span class="result-label" id="resLabelName">Taxpayer Name</span>
                    <span id="resName" class="result-value">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label" id="resLabelInfo">Taxpayer PIN</span>
                    <span id="resPIN" class="result-value">-</span>
                </div>
                <div id="extraInfoArea" style="display: none;">
                    <div class="result-item">
                        <span class="result-label">Category</span>
                        <span id="resType" class="result-value">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Current Status</span>
                        <span id="resStatus" class="result-value">-</span>
                    </div>
                </div>
                <button class="cert-btn" id="generateCertBtn">Generate PIN Certificate</button>
            </div>
        </div>

        <!-- Modal for additional details -->
        <div id="certModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Certificate Details</h2>
                    <span style="cursor: pointer; font-size: 24px;" onclick="closeModal()">&times;</span>
                </div>
                <form id="certDetailsForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="inEmail" value="POWELDAYCK@GMAIL.COM" required>
                        </div>
                        <div class="form-group">
                            <label>Building</label>
                            <input type="text" id="inBuilding" value="Lokita">
                        </div>
                        <div class="form-group">
                            <label>Street/Road</label>
                            <input type="text" id="inStreet" value="Lotodo">
                        </div>
                        <div class="form-group">
                            <label>City/Town</label>
                            <input type="text" id="inCity" value="Kapenguria">
                        </div>
                        <div class="form-group">
                            <label>County</label>
                            <input type="text" id="inCounty" value="WEST POKOT">
                        </div>
                        <div class="form-group">
                            <label>District</label>
                            <input type="text" id="inDistrict" value="West Pokot District">
                        </div>
                        <div class="form-group">
                            <label>Tax Area</label>
                            <input type="text" id="inTaxArea" value="Kapenguria">
                        </div>
                        <div class="form-group">
                            <label>Station</label>
                            <input type="text" id="inStation" value="KITALE">
                        </div>
                        <div class="form-group">
                            <label>P.O. Box</label>
                            <input type="text" id="inBox" value="66">
                        </div>
                        <div class="form-group">
                            <label>Postal Code</label>
                            <input type="text" id="inPostal" value="30600">
                        </div>
                        <div class="form-group">
                            <label>Effective From Date</label>
                            <input type="text" id="inEffectiveDate" value="26/08/2021">
                        </div>
                        <div class="form-group">
                            <label>L.R. Number</label>
                            <input type="text" id="inLRNumber" value="">
                        </div>
                        <div class="form-group">
                            <label>Tax Obligation</label>
                            <input type="text" id="inTaxObligation" value="Income Tax - Resident Individual">
                        </div>
                        <div class="form-group">
                            <label>Effective Till</label>
                            <input type="text" id="inEffectiveTill" value="N.A.">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="inStatus">
                                <option value="Active" selected>Active</option>
                                <option value="Dormant">Dormant</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="tw-mt-8 tw-border-t tw-border-white/10 tw-pt-6">
                        <h3 class="tw-text-white tw-text-lg tw-font-bold tw-mb-4">Certificate Preview</h3>
                        <div id="digitalPreview" class="tw-bg-gray-100 tw-p-4 tw-rounded-lg tw-overflow-auto tw-h-[600px] tw-relative">
                            
                            <!-- Certificate Container (Hidden until needed) -->
                            <div id="certificate-container">
                                <div id="print-area">
                                    <div class="cert-header">
                                        <div class="cert-logo-section">
                                            <img src="image1.jpeg" alt="KRA Logo" id="kra-logo">
                                            <div class="kra-text">
                                                <!-- KENYA REVENUE<br>AUTHORITY -->
                                            </div>
                                        </div>
                                        <div class="cert-label">
                                            PIN Certificate
                                        </div>
                                        <div class="cert-contact-info">
                                            <strong>For General Tax Questions<br>Contact KRA Call Centre</strong><br>
                                            Tel: +254 (020) 4999 999<br>
                                            Cell: +254(0711)099 999<br>
                                            Email: callcentre@kra.go.ke
                                        </div>
                                    </div>

                                    <div class="date-pin-section">
                                        <div class="date-pin-box">
                                            <div class="cert-date"><strong>Certificate Date :</strong> <span id="data-cert-date"></span></div>
                                            <div class="pin-label">Personal Identification Number</div>
                                            <div class="pin-value" id="data-pin"></div>
                                        </div>
                                    </div>

                                    <div class="intro-text">
                                        This is to certify that taxpayer shown herein has been registered with Kenya Revenue Authority
                                    </div>

                                    <div class="section-title">Taxpayer Information</div>
                                    <table class="cert-table">
                                        <tr>
                                            <td class="bg-grey">Taxpayer Name</td>
                                            <td id="data-name"></td>
                                        </tr>
                                        <tr>
                                            <td class="bg-grey">Email Address</td>
                                            <td id="data-email"></td>
                                        </tr>
                                    </table>

                                    <div class="section-title">Registered Address</div>
                                    <table class="cert-table">
                                        <tr>
                                            <td><strong>L.R. Number :</strong> <span id="data-lr"></span></td>
                                            <td><strong>Building :</strong> <span id="data-building"></span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Street/Road :</strong> <span id="data-street"></span></td>
                                            <td><strong>City/Town :</strong> <span id="data-city"></span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>County :</strong> <span id="data-county"></span></td>
                                            <td><strong>District :</strong> <span id="data-district"></span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tax Area :</strong> <span id="data-tax-area"></span></td>
                                            <td><strong>Station :</strong> <span id="data-station"></span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>P. O. Box :</strong> <span id="data-box"></span></td>
                                            <td><strong>Postal Code :</strong> <span id="data-postal"></span></td>
                                        </tr>
                                    </table>

                                    <div class="section-title">Tax Obligation(s) Registration</div>
                                    <table class="cert-table obligation-table">
                                        <thead>
                                            <tr>
                                                <th>Sr. No.</th>
                                                <th>Tax Obligation(s)</th>
                                                <th>Effective From Date</th>
                                                <th>Effective Till</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="data-obligations-body">
                                            <!-- Loaded via JS -->
                                        </tbody>
                                    </table>

                                    <div class="footer-text">
                                        The above PIN must appear on all your tax invoices and correspondences with Kenya Revenue Authority. 
                                        Your accounting end date is 31st December as per the provisions stated in the Income Tax Act unless 
                                        a change has been approved by the Commissioner-Domestic Taxes Department.
                                    </div>

                                    <div class="disclaimer">
                                        Disclaimer : This is a system generated certificate and does not require signature.
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <div class="tw-flex tw-gap-4 tw-mt-6">
                        <button type="submit" class="tw-flex-1">Download Certificate</button>
                    </div>
                    <button type="button" class="cert-btn btn-secondary tw-w-full tw-mt-2" onclick="closeModal()">Cancel</button>
                </form>
            </div>
        </div>

        <div class="samples" id="samplesID">
            <span class="sample-tag" onclick="fillSample('ID', 'KE', '41789723')">KE Sample</span>
            <span class="sample-tag" onclick="fillSample('ID', 'NKE', '787528')">NKE Sample</span>
            <span class="sample-tag" onclick="fillSample('ID', 'COMP', '0000200S4304')">COMP Sample</span>
        </div>

        <div class="samples" id="samplesPIN" style="display: none;">
            <span class="sample-tag" onclick="fillSample('PIN', 'A016881319Q')">Docx PIN (A01)</span>
            <span class="sample-tag" onclick="fillSample('PIN', 'P318295670X')">Valid PIN (P)</span>
            <span class="sample-tag" onclick="fillSample('PIN', 'A744610021G')">Individual (A)</span>
            <span class="sample-tag" onclick="fillSample('PIN', 'A521040203F')">Sample (A)</span>
        </div>
    </div>

    <script src="kra_api.js"></script>
    <script>
        let currentMode = 'ID';

        function switchTab(mode) {
            currentMode = mode;
            // Tabs
            document.getElementById('tabID').classList.toggle('active', mode === 'ID');
            document.getElementById('tabPIN').classList.toggle('active', mode === 'PIN');
            
            // Forms
            document.getElementById('checkerFormID').style.display = mode === 'ID' ? 'block' : 'none';
            document.getElementById('checkerFormPIN').style.display = mode === 'PIN' ? 'block' : 'none';
            
            // Samples
            document.getElementById('samplesID').style.display = mode === 'ID' ? 'flex' : 'none';
            document.getElementById('samplesPIN').style.display = mode === 'PIN' ? 'flex' : 'none';
            
            // UI Reset
            document.getElementById('errorArea').style.display = 'none';
            document.getElementById('resultsArea').style.display = 'none';
        }

        function fillSample(mode, val1, val2) {
            if (mode === 'ID') {
                document.getElementById('taxpayerType').value = val1;
                document.getElementById('taxpayerID').value = val2;
            } else {
                document.getElementById('kraPIN').value = val1;
            }
        }

        // Generic Submit Handler
        async function handleSubmission(e, mode) {
            e.preventDefault();
            
            const errorArea = document.getElementById('errorArea');
            const resultsArea = document.getElementById('resultsArea');
            const btnText = document.getElementById(`btnText${mode}`);
            const loader = document.getElementById(`loader${mode}`);
            const submitBtn = document.getElementById(`submitBtn${mode}`);
            const originalText = btnText.textContent;

            errorArea.style.display = 'none';
            resultsArea.style.display = 'none';
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            loader.style.display = 'block';

            // Verifying status animation
            let dots = 0;
            const statusInt = setInterval(() => {
                dots = (dots + 1) % 4;
                btnText.textContent = 'Verifying' + '.'.repeat(dots);
                btnText.style.display = 'block';
            }, 600);

            try {
                let result;
                if (mode === 'ID') {
                    const type = document.getElementById('taxpayerType').value;
                    const id = document.getElementById('taxpayerID').value;
                    result = await window.kraClient.checkPIN(type, id);
                    
                    document.getElementById('resLabelName').textContent = 'Verified Taxpayer Name';
                    document.getElementById('resLabelInfo').textContent = 'Taxpayer PIN';
                    document.getElementById('resName').textContent = result.TaxpayerName;
                    document.getElementById('resPIN').textContent = result.TaxpayerPIN;
                    document.getElementById('extraInfoArea').style.display = 'none';
                } else {
                    const pin = document.getElementById('kraPIN').value;
                    result = await window.kraClient.checkPINByPIN(pin);
                    
                    document.getElementById('resLabelName').textContent = 'Taxpayer Name';
                    document.getElementById('resLabelInfo').textContent = 'PIN Number';
                    document.getElementById('resName').textContent = result.TaxpayerName;
                    document.getElementById('resPIN').textContent = result.TaxpayerPIN;
                    document.getElementById('resType').textContent = result.Type;
                    document.getElementById('resStatus').textContent = result.Status;
                    document.getElementById('extraInfoArea').style.display = 'block';
                }
                
                clearInterval(statusInt);
                resultsArea.style.display = 'block';
                resultsArea.scrollIntoView({ behavior: 'smooth' });
            } catch (err) {
                clearInterval(statusInt);
                let msg = err.message;
                if (msg.includes('EAI_AGAIN') || msg.includes('fetch failed')) {
                    msg = "KRA Sandbox is temporarily unreachable. We are automatically retrying behind the scenes, please try again in a moment.";
                }
                errorArea.textContent = msg;
                errorArea.style.display = 'block';
            } finally {
                clearInterval(statusInt);
                submitBtn.disabled = false;
                btnText.textContent = originalText;
                btnText.style.display = 'block';
                loader.style.display = 'none';
            }
        }

        document.getElementById('checkerFormID').addEventListener('submit', (e) => handleSubmission(e, 'ID'));
        document.getElementById('checkerFormPIN').addEventListener('submit', (e) => handleSubmission(e, 'PIN'));

        // PDF Generation Logic
        const modal = document.getElementById('certModal');
        const generateCertBtn = document.getElementById('generateCertBtn');
        const certDetailsForm = document.getElementById('certDetailsForm');

        // Interactive Preview Logic
        function updateDigitalPreview() {
            // Populate Fields
            document.getElementById('data-cert-date').textContent = document.getElementById('inEffectiveDate').value;
            document.getElementById('data-pin').textContent = document.getElementById('resPIN').textContent || document.getElementById('kraPIN').value || 'A000000000X';
            
            // Handle fallback for name if resName is empty or placeholder
            const name = document.getElementById('resName').textContent;
            document.getElementById('data-name').textContent = (name && name !== '-') ? name : 'Taxpayer Name';
            document.getElementById('data-email').textContent = document.getElementById('inEmail').value;
            
            document.getElementById('data-building').textContent = document.getElementById('inBuilding').value;
            document.getElementById('data-street').textContent = document.getElementById('inStreet').value;
            document.getElementById('data-city').textContent = document.getElementById('inCity').value;
            document.getElementById('data-county').textContent = document.getElementById('inCounty').value;
            document.getElementById('data-district').textContent = document.getElementById('inDistrict').value;
            document.getElementById('data-tax-area').textContent = document.getElementById('inTaxArea').value;
            document.getElementById('data-station').textContent = document.getElementById('inStation').value;
            document.getElementById('data-box').textContent = document.getElementById('inBox').value;
            document.getElementById('data-postal').textContent = document.getElementById('inPostal').value;

            // Obligation Table
            const body = document.getElementById('data-obligations-body');
            body.innerHTML = ''; // Clear existing
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>1</td>
                <td>${document.getElementById('inTaxObligation').value}</td>
                <td>${document.getElementById('inEffectiveDate').value}</td>
                <td>${document.getElementById('inEffectiveTill').value}</td>
                <td>${document.getElementById('inStatus').value}</td>
            `;
            body.appendChild(tr);
        }
        
        // Add change listeners to all form inputs
        ['inEmail', 'inBuilding', 'inStreet', 'inCity', 'inCounty', 'inDistrict', 'inTaxArea', 
         'inStation', 'inBox', 'inPostal', 'inEffectiveDate', 'inLRNumber', 
         'inTaxObligation', 'inEffectiveTill', 'inStatus'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('input', updateDigitalPreview);
                el.addEventListener('change', updateDigitalPreview);
            }
        });

        function closeModal() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) closeModal();
        }

        generateCertBtn.addEventListener('click', () => {
            updateDigitalPreview();
            modal.style.display = 'block';
        });

        certDetailsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                // IMPORTANT: We must capture the element BEFORE we unscale it, or clone it.
                // However, html2pdf handles scaling well if we configure it right.
                // The issue is the visually scaled-down preview might render small.
                // Solution: Clone the node, append to body, remove scale, generate, then remove.
                
                const originalElement = document.getElementById('certificate-container');
                const clone = originalElement.cloneNode(true);
                
                // Create a wrapper to holding the clone "visibly" but hidden from user
                // This prevents html2canvas from thinking it's off-screen/clipped
                const wrapper = document.createElement('div');
                wrapper.style.position = 'fixed';
                wrapper.style.top = '0';
                wrapper.style.left = '0';
                wrapper.style.zIndex = '-9999';
                // We use opacity 0 instead of display:none or off-screen
                wrapper.style.opacity = '0'; 
                wrapper.style.pointerEvents = 'none';
                
                // Reset transform on clone to ensure full resolution capture
                clone.style.transform = 'none';
                clone.style.margin = '0 auto'; // Center it in the wrapper (good practice)
                
                wrapper.appendChild(clone);
                document.body.appendChild(wrapper);

                const pin = document.getElementById('data-pin').textContent || 'CERT';
                const opt = {
                    margin: 0,
                    filename: `KRA_Certificate_${pin}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 3, 
                        useCORS: true, 
                        letterRendering: true,
                        // Ensure it captures the full height
                        scrollY: 0,
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                await html2pdf().set(opt).from(clone).save();
                
                // Cleanup
                document.body.removeChild(wrapper);

                // Success feedback
                btn.textContent = 'âœ“ Downloaded';
                setTimeout(() => {
                    closeModal();
                    btn.textContent = originalText;
                }, 1000);
            } catch (error) {
                console.error('PDF Error:', error);
                alert('PDF Generation Error: ' + error.message);
                btn.textContent = originalText;
            } finally {
                btn.disabled = false;
            }
        });

    </script>
</body>
</html>
