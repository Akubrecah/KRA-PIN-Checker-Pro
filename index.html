<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRA PIN Checker Pro | AkubrecaH</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="data:,">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Add Supabase & SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="supabase-client.js"></script>
    <script>
        tailwind.config = {
            prefix: 'tw-',
            corePlugins: {
                preflight: false,
            }
        }
        
        // Smart Get Started button - redirect to dashboard or login
        function handleGetStarted() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (user && user.onboarded) {
                window.location.href = 'dashboard.html';
            } else if (user && user.loggedIn) {
                window.location.href = 'onboarding.html';
            } else {
                window.location.href = 'login.html';
            }
        }
        
        // Update login link based on user state
        window.addEventListener('DOMContentLoaded', async () => {
            // Check for potential session even before waiting for full init
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (user && user.loggedIn) {
               // Optional: redirect immediately if local storage says logged in, 
               // but verifying with Supabase is safer.
               // For now, let's rely on Supabase init to confirm valid session.
            }

            const checkInit = setInterval(async () => {
                if (window.SupabaseClient && window.supabase) {
                    clearInterval(checkInit);
                    const session = await window.SupabaseClient.auth.getSession();
                    if (session) {
                        window.location.href = 'dashboard.html';
                    }
                }
            }, 100);

            const loginLink = document.getElementById('loginLink');
            
            if (user && user.loggedIn && loginLink) {
                const name = user.name || user.email.split('@')[0];
                loginLink.textContent = name;
                loginLink.href = 'dashboard.html';
            }
        });
    </script>
    <style>
        /* Standalone PDF Generator Styles */
        :root {
            --kra-red: #ff0000;
            --kra-black: #000000;
            --kra-grey: #f3f4f6;
        }

        /* Certificate Layout */
        #certificate-container {
            width: 210mm;
            height: 297mm;
            max-height: 297mm; /* Strict height limit */
            overflow: hidden; /* Prevent spillover */
            background: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            transform: scale(0.6); /* Scaled down for preview */
            transform-origin: top left;
        }

        #print-area {
            padding: 2.5cm;
            color: black;
            flex: 1;
            display: flex;
            flex-direction: column;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .cert-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            border-bottom: 2px solid black;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .cert-logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .cert-logo-section img {
            height: 60px;
        }

        .kra-text {
            font-weight: 900;
            font-size: 16px;
            line-height: 1.1;
            color: black;
        }

        .cert-label {
            background: #e5e7eb;
            padding: 10px 40px;
            font-weight: 900;
            font-size: 20px;
            border: 1px solid #d1d5db;
        }

        .cert-contact-info {
            text-align: right;
            font-size: 9px;
            line-height: 1.4;
        }

        .date-pin-section {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .date-pin-box {
            text-align: right;
            line-height: 1.5;
        }

        .cert-date {
            font-size: 11px;
        }

        .pin-label {
            font-weight: 700;
            font-size: 12px;
            margin-top: 5px;
        }

        .pin-value {
            font-weight: 500;
            font-size: 11px;
        }

        .intro-text {
            text-align: center;
            font-size: 11px;
            margin-bottom: 20px;
        }

        .section-title {
            text-align: center;
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 10px;
            text-transform: capitalize;
        }

        .cert-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 11px;
        }

        .cert-table, .cert-table th, .cert-table td {
            border: 1px solid black;
        }

        .cert-table th, .cert-table td {
            padding: 3px 6px;
            text-align: left;
        }

        .obligation-table th, .obligation-table td {
            text-align: center;
            vertical-align: middle;
            font-size: 9px; /* Smaller font to fit data */
            padding: 2px 4px; /* Tighter padding */
            white-space: nowrap; /* Prevent wrapping implies scaling or fitting */
        }

        .obligation-table thead th {
            font-weight: 700;
        }
        .bg-grey {
            /* background-color: #f9fafb; Removed fill */
            font-weight: 700;
            width: 30%;
        }


        .footer-text {
            font-size: 10px;
            line-height: 1.5;
            margin-top: auto;
            padding-top: 20px;
        }

        .disclaimer {
            border-top: 1px solid black;
            padding-top: 5px;
            margin-top: 30px;
            font-weight: 700;
            font-size: 10px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <header class="site-header">
        <nav class="nav-glass">
            <div class="logo"><a href="index.html">AkubrecaH</a></div>
            <div class="nav-links">
                <a href="index.html" class="nav-link active">Home</a>
                <a href="pricing.html" class="nav-link">Pricing</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="contact.html" class="nav-link">Contact</a>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <a href="login.html" class="nav-link" id="loginLink">Login</a>
                <button class="btn-primary" onclick="handleGetStarted()">Get Started</button>
            </div>
        </nav>
    </header>

        <!-- Hero Section -->
        <section class="hero-section" style="position: relative;">
            <!-- Purple Glow Effect -->
            <div style="position: absolute; top: -200px; left: 50%; transform: translateX(-50%); width: 800px; height: 600px; background: var(--gradient-glow); pointer-events: none; z-index: 0;"></div>
            
            <div class="hero-text" style="position: relative; z-index: 1;">
                <h1 style="color: var(--color-text-dark);">Verify Any <br><span class="text-gradient">KRA PIN</span> Instantly.</h1>
                <p style="font-size: 1.15rem; color: var(--color-text); margin-bottom: 2.5rem;">Professional tax compliance tool for individuals and businesses. Instant validations, automated PDF certificates, and developer-first APIs.</p>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button class="btn-primary" onclick="handleMainAction()">
                        Start for Free
                    </button>
                    <button class="btn-secondary" onclick="window.location.href='about.html'">
                        <i data-lucide="play-circle" style="width: 20px;"></i> Learn More
                    </button>
                </div>
                </div>
            </div>
            <div class="hero-visual">
                <!-- Abstract Premium Shapes -->
                <div style="position: absolute; width: 600px; height: 600px; background: radial-gradient(circle, rgba(220,38,38,0.1) 0%, rgba(255,255,255,0) 70%); top: -100px; right: -100px;"></div>
                
                <div class="glass-panel" style="position: relative; z-index: 10; padding: 2.5rem; border-radius: 16px; background: white; box-shadow: var(--shadow-card); border: 1px solid var(--color-border); width: 80%;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 2rem; border-bottom: 1px solid var(--color-border); padding-bottom: 1rem;">
                        <span style="font-weight: 700; color: var(--color-text-dark);">PIN Validation Status</span>
                        <span style="color: #10B981; font-weight: 600; background: #ECFDF5; padding: 4px 12px; border-radius: 99px; font-size: 0.85rem;">Active & Valid</span>
                    </div>
                    
                    <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 1.5rem;">
                         <div style="width: 48px; height: 48px; background: #F1F5F9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #64748B;">
                             <i data-lucide="user" style="width: 24px;"></i>
                         </div>
                         <div>
                             <div style="font-weight: 700; color: var(--color-text-dark);">Jane Doe</div>
                             <div style="font-size: 0.9rem; color: #64748B;">P051XXXXXXZ</div>
                         </div>
                    </div>

                    <div style="background: #F8FAFC; padding: 1rem; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            <span style="color: #64748B;">Station</span>
                            <span style="font-weight: 600; color: var(--color-text-dark);">North Nairobi</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.9rem;">
                            <span style="color: #64748B;">Obligation</span>
                            <span style="font-weight: 600; color: var(--color-text-dark);">Income Tax Resident</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Marquee -->
        <div class="marquee-container">
            <div class="marquee-content">
                <span class="marquee-item">Instant Verification</span>
                <span class="marquee-item">•</span>
                <span class="marquee-item">Secure Processing</span>
                <span class="marquee-item">•</span>
                <span class="marquee-item">PDF Generation</span>
                <span class="marquee-item">•</span>
                <span class="marquee-item">Developer API</span>
                <span class="marquee-item">•</span>
                <span class="marquee-item">Instant Verification</span>
                <span class="marquee-item">•</span>
                <span class="marquee-item">Secure Processing</span>
                 <span class="marquee-item">•</span>
                <span class="marquee-item">PDF Generation</span>
                <span class="marquee-item">•</span>
                <span class="marquee-item">Developer API</span>
            </div>
        </div>

        <!-- How It Works: 3 Steps (Inspired by landing-page.io) -->
        <section style="padding: 5rem 2rem; max-width: 1100px; margin: 0 auto;">
            <h2 style="font-size: 2.5rem; text-align: center; margin-bottom: 1rem; color: var(--color-text-dark);">How It Works</h2>
            <p style="text-align: center; color: var(--color-text); margin-bottom: 3rem; max-width: 600px; margin-left: auto; margin-right: auto;">From ID to verified PIN certificate in 3 simple steps.</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; position: relative;">
                <!-- Step 1 -->
                <div style="background: white; border-radius: 16px; padding: 2rem; text-align: center; border: 1px solid var(--color-border); box-shadow: var(--shadow-card);">
                    <div style="width: 56px; height: 56px; background: rgba(220, 38, 38, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: var(--color-primary);">
                        <i data-lucide="search" style="width: 28px;"></i>
                    </div>
                    <div style="font-size: 0.85rem; font-weight: 600; color: var(--color-primary); margin-bottom: 0.5rem;">Step 1</div>
                    <h3 style="font-size: 1.25rem; margin-bottom: 0.75rem; color: var(--color-text-dark);">Enter Your ID</h3>
                    <p style="color: var(--color-text); font-size: 0.95rem;">Input your National ID, Alien ID, or existing KRA PIN to begin the verification.</p>
                </div>
                
                <!-- Step 2 -->
                <div style="background: white; border-radius: 16px; padding: 2rem; text-align: center; border: 1px solid var(--color-border); box-shadow: var(--shadow-card);">
                    <div style="width: 56px; height: 56px; background: rgba(220, 38, 38, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: var(--color-primary);">
                        <i data-lucide="check-circle" style="width: 28px;"></i>
                    </div>
                    <div style="font-size: 0.85rem; font-weight: 600; color: var(--color-primary); margin-bottom: 0.5rem;">Step 2</div>
                    <h3 style="font-size: 1.25rem; margin-bottom: 0.75rem; color: var(--color-text-dark);">Instant Verification</h3>
                    <p style="color: var(--color-text); font-size: 0.95rem;">Our system queries the KRA sandbox in milliseconds and returns your full taxpayer details.</p>
                </div>
                
                <!-- Step 3 -->
                <div style="background: white; border-radius: 16px; padding: 2rem; text-align: center; border: 1px solid var(--color-border); box-shadow: var(--shadow-card);">
                    <div style="width: 56px; height: 56px; background: rgba(220, 38, 38, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; color: var(--color-primary);">
                        <i data-lucide="file-down" style="width: 28px;"></i>
                    </div>
                    <div style="font-size: 0.85rem; font-weight: 600; color: var(--color-primary); margin-bottom: 0.5rem;">Step 3</div>
                    <h3 style="font-size: 1.25rem; margin-bottom: 0.75rem; color: var(--color-text-dark);">Download Certificate</h3>
                    <p style="color: var(--color-text); font-size: 0.95rem;">Generate and download a professional A4 PDF certificate, ready for print or submission.</p>
                </div>
            </div>
        </section>

        <!-- Bento Grid Features -->
        <section class="bento-section">
            <h2 style="font-size: 3rem; margin-bottom: 3rem; text-align: center;">Everything you need.</h2>
            <div class="bento-grid">
                <div class="bento-card bento-large">
                    <div class="bento-icon"><i data-lucide="zap"></i></div>
                    <h3>Lightning Fast</h3>
                    <p>Direct integration with KRA Sandbox for millisecond response times.</p>
                </div>
                <div class="bento-card">
                    <div class="bento-icon"><i data-lucide="shield-check"></i></div>
                    <h3>Secure</h3>
                    <p>Client-side processing. Your data never leaves your browser.</p>
                </div>
                <div class="bento-card bento-tall">
                    <div class="bento-icon"><i data-lucide="file-text"></i></div>
                    <h3>A4 Certificates</h3>
                    <p>Generate high-fidelity, print-ready PDF certificates compliant with 2026 standards.</p>
                    <div style="margin-top: 2rem; background: rgba(255,255,255,0.1); border-radius: 12px; height: 100px;"></div>
                </div>
                <div class="bento-card bento-primary" style="grid-column: span 2;">
                    <div class="bento-icon" style="color: var(--color-primary);"><i data-lucide="code"></i></div>
                    <h3>Dev Friendly</h3>
                    <p>Built for integration.</p>
                </div>
                <div class="bento-card">
                     <div class="bento-icon"><i data-lucide="clock"></i></div>
                    <h3>History</h3>
                    <p>Track your verifications.</p>
                </div>
            </div>
        </section>

        <!-- Tool Section -->
        <section id="tool" style="display: none;">
            <div class="tool-wrapper">
                <header>
                    <h1>Scanner Console</h1>
                    <p class="subtitle">Access KRA Database</p>
                </header>
                <!-- Existing Functional Content Preserved Below -->

        <div class="tabs">
            <div class="tab active" id="tabID" onclick="switchTab('ID')">Verify by ID</div>
            <div class="tab" id="tabPIN" onclick="switchTab('PIN')">Verify by PIN</div>
        </div>

        <!-- Form 1: Verify by ID -->
        <form id="checkerFormID" class="checker-form">
            <div class="form-group">
                <label for="taxpayerType">Taxpayer Type</label>
                <select id="taxpayerType" required>
                    <option value="KE">Kenyan Resident (KE)</option>
                    <option value="NKE">Non-Kenyan Resident (NKE)</option>
                    <option value="NKENR">Non-Kenyan Non-Resident (NKENR)</option>
                    <option value="COMP">Non-Individual/Company (COMP)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="taxpayerID">Taxpayer ID / National ID</label>
                <input type="text" id="taxpayerID" placeholder="Enter ID number" required>
            </div>

            <button type="submit" id="submitBtnID">
                <span id="btnTextID">Verify Identity</span>
                <div class="loader" id="loaderID"></div>
            </button>
        </form>

        <!-- Form 2: Verify by PIN -->
        <form id="checkerFormPIN" class="checker-form" style="display: none;">
            <div class="form-group">
                <label for="kraPIN">KRA PIN</label>
                <input type="text" id="kraPIN" placeholder="e.g. P318295670X" required pattern="^[AP][0-9]{9}[A-Z]$" title="Starts with A or P, 9 digits, ends with a letter">
            </div>

            <button type="submit" id="submitBtnPIN">
                <span id="btnTextPIN">Check PIN Status</span>
                <div class="loader" id="loaderPIN"></div>
            </button>
        </form>

        <div id="errorArea" class="error-message"></div>

        <div id="resultsArea" class="results-area">
            <div class="result-card">
                <div class="result-item">
                    <span class="result-label" id="resLabelName">Taxpayer Name</span>
                    <span id="resName" class="result-value">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label" id="resLabelInfo">Taxpayer PIN</span>
                    <span id="resPIN" class="result-value">-</span>
                </div>
                <div id="extraInfoArea" style="display: none;">
                    <div class="result-item">
                        <span class="result-label">Category</span>
                        <span id="resType" class="result-value">-</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">Current Status</span>
                        <span id="resStatus" class="result-value">-</span>
                    </div>
                </div>
                <button class="cert-btn" id="generateCertBtn">Generate PIN Certificate</button>
            </div>
        </div>

        <!-- Modal for additional details -->
        <div id="certModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Certificate Details</h2>
                    <span style="cursor: pointer; font-size: 24px;" onclick="closeModal()">&times;</span>
                </div>
                <form id="certDetailsForm">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="inEmail" value="POWELDAYCK@GMAIL.COM" required>
                        </div>
                        <div class="form-group">
                            <label>Building</label>
                            <input type="text" id="inBuilding" value="Lokita">
                        </div>
                        <div class="form-group">
                            <label>Street/Road</label>
                            <input type="text" id="inStreet" value="Lotodo">
                        </div>
                        <div class="form-group">
                            <label>City/Town</label>
                            <input type="text" id="inCity" value="Kapenguria">
                        </div>
                        <div class="form-group">
                            <label>County</label>
                            <input type="text" id="inCounty" value="WEST POKOT">
                        </div>
                        <div class="form-group">
                            <label>District</label>
                            <input type="text" id="inDistrict" value="West Pokot District">
                        </div>
                        <div class="form-group">
                            <label>Tax Area</label>
                            <input type="text" id="inTaxArea" value="Kapenguria">
                        </div>
                        <div class="form-group">
                            <label>Station</label>
                            <input type="text" id="inStation" value="KITALE">
                        </div>
                        <div class="form-group">
                            <label>P.O. Box</label>
                            <input type="text" id="inBox" value="66">
                        </div>
                        <div class="form-group">
                            <label>Postal Code</label>
                            <input type="text" id="inPostal" value="30600">
                        </div>
                        <div class="form-group">
                            <label>Effective From Date</label>
                            <input type="text" id="inEffectiveDate" value="26/08/2021">
                        </div>
                        <div class="form-group">
                            <label>L.R. Number</label>
                            <input type="text" id="inLRNumber" value="">
                        </div>
                        <div class="form-group">
                            <label>Tax Obligation</label>
                            <input type="text" id="inTaxObligation" value="Income Tax - Resident Individual">
                        </div>
                        <div class="form-group">
                            <label>Effective Till</label>
                            <input type="text" id="inEffectiveTill" value="N.A.">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="inStatus">
                                <option value="Active" selected>Active</option>
                                <option value="Dormant">Dormant</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="tw-mt-8 tw-border-t tw-border-white/10 tw-pt-6">
                        <h3 class="tw-text-white tw-text-lg tw-font-bold tw-mb-4">Certificate Preview</h3>
                        <div id="digitalPreview" class="tw-bg-gray-100 tw-p-4 tw-rounded-lg tw-overflow-auto tw-h-[600px] tw-relative">
                            
                            <!-- Certificate Container (Hidden until needed) -->
                            <div id="certificate-container">
                                <div id="print-area">
                                    <div class="cert-header">
                                        <div class="cert-logo-section">
                                            <img src="image1.jpeg" alt="KRA Logo" id="kra-logo">
                                            <div class="kra-text">
                                                <!-- KENYA REVENUE<br>AUTHORITY -->
                                            </div>
                                        </div>
                                        <div class="cert-label">
                                            PIN Certificate
                                        </div>
                                        <div class="cert-contact-info">
                                            <strong>For General Tax Questions<br>Contact KRA Call Centre</strong><br>
                                            Tel: +254 (020) 4999 999<br>
                                            Cell: +254(0711)099 999<br>
                                            Email: callcentre@kra.go.ke
                                        </div>
                                    </div>

                                    <div class="date-pin-section">
                                        <div class="date-pin-box">
                                            <div class="cert-date"><strong>Certificate Date :</strong> <span id="data-cert-date"></span></div>
                                            <div class="pin-label">Personal Identification Number</div>
                                            <div class="pin-value" id="data-pin"></div>
                                        </div>
                                    </div>

                                    <div class="intro-text">
                                        This is to certify that taxpayer shown herein has been registered with Kenya Revenue Authority
                                    </div>

                                    <div class="section-title">Taxpayer Information</div>
                                    <table class="cert-table">
                                        <tr>
                                            <td class="bg-grey">Taxpayer Name</td>
                                            <td id="data-name"></td>
                                        </tr>
                                        <tr>
                                            <td class="bg-grey">Email Address</td>
                                            <td id="data-email"></td>
                                        </tr>
                                    </table>

                                    <div class="section-title">Registered Address</div>
                                    <table class="cert-table">
                                        <tr>
                                            <td><strong>L.R. Number :</strong> <span id="data-lr"></span></td>
                                            <td><strong>Building :</strong> <span id="data-building"></span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Street/Road :</strong> <span id="data-street"></span></td>
                                            <td><strong>City/Town :</strong> <span id="data-city"></span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>County :</strong> <span id="data-county"></span></td>
                                            <td><strong>District :</strong> <span id="data-district"></span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>Tax Area :</strong> <span id="data-tax-area"></span></td>
                                            <td><strong>Station :</strong> <span id="data-station"></span></td>
                                        </tr>
                                        <tr>
                                            <td><strong>P. O. Box :</strong> <span id="data-box"></span></td>
                                            <td><strong>Postal Code :</strong> <span id="data-postal"></span></td>
                                        </tr>
                                    </table>

                                    <div class="section-title">Tax Obligation(s) Registration</div>
                                    <table class="cert-table obligation-table">
                                        <thead>
                                            <tr>
                                                <th>Sr. No.</th>
                                                <th>Tax Obligation(s)</th>
                                                <th>Effective From Date</th>
                                                <th>Effective Till</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody id="data-obligations-body">
                                            <!-- Loaded via JS -->
                                        </tbody>
                                    </table>

                                    <div class="footer-text">
                                        The above PIN must appear on all your tax invoices and correspondences with Kenya Revenue Authority. 
                                        Your accounting end date is 31st December as per the provisions stated in the Income Tax Act unless 
                                        a change has been approved by the Commissioner-Domestic Taxes Department.
                                    </div>

                                    <div class="disclaimer">
                                        Disclaimer : This is a system generated certificate and does not require signature.
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                    <div class="tw-flex tw-gap-4 tw-mt-6">
                        <button type="submit" class="tw-flex-1">Download Certificate</button>
                    </div>
                    <button type="button" class="cert-btn btn-secondary tw-w-full tw-mt-2" onclick="closeModal()">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Auth Modal -->
        <div id="authModal" class="modal">
            <div class="modal-content" style="max-width: 440px; text-align: center; border: 2px solid var(--color-text);">
                <div class="modal-header" style="justify-content: center; border: none; margin-bottom: 1.5rem;">
                    <h2 id="authTitle" style="font-size: 2rem;">Welcome Back</h2>
                </div>
                
                <div class="tabs" style="justify-content: center; margin-bottom: 2rem; background: var(--color-surface); padding: 8px; border-radius: 16px;">
                    <button class="tab active" onclick="switchAuthMode('login')" id="tabLogin" style="flex: 1;">Login</button>
                    <button class="tab" onclick="switchAuthMode('register')" id="tabRegister" style="flex: 1;">Register</button>
                </div>

                <form id="authForm" style="display: flex; flex-direction: column; gap: 1rem;">
                    <div class="form-group" id="roleSelectGroup" style="display: none; text-align: left;">
                        <label style="font-weight: 700; margin-bottom: 8px; display: block;">I am a...</label>
                        <select id="authRole" onchange="toggleAuthFields()" style="width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--color-surface); background: white;">
                            <option value="personal">Personal User (Pay-per-use)</option>
                            <option value="cyber">Cyber / Business (Subscription)</option>
                        </select>
                    </div>

                    <div class="form-group" style="text-align: left;">
                        <input type="email" id="authEmail" placeholder="Email Address" required style="width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--color-surface);">
                    </div>
                    <div class="form-group" style="text-align: left;">
                        <input type="password" id="authPassword" placeholder="Password" required style="width: 100%; padding: 14px; border-radius: 12px; border: 2px solid var(--color-surface);">
                    </div>
                    
                    <button type="submit" id="authSubmitBtn" class="btn-primary" style="width: 100%; padding: 16px; margin-top: 1rem;">Login</button>
                </form>
                <button class="btn-primary" onclick="closeAuth()" style="width: 100%; padding: 16px; margin-top: 12px; background: var(--color-surface); color: var(--color-text);">Cancel</button>
            </div>
        </div>

        <!-- Pricing Modal -->
        <div id="pricingModal" class="modal">
            <div class="modal-content" style="max-width: 900px; border: 2px solid var(--color-text);">
                <div class="modal-header" style="border-bottom: 2px solid var(--color-surface); padding-bottom: 1.5rem;">
                    <h2 style="font-size: 2.5rem;">Choose Your Plan</h2>
                    <span style="cursor: pointer; font-size: 32px; font-weight: 900;" onclick="document.getElementById('pricingModal').style.display='none'">&times;</span>
                </div>
                <div class="bento-grid" style="grid-template-rows: auto; padding-top: 2rem;">
                    <!-- Personal Plan -->
                    <div class="bento-card" style="background: white; border: 2px solid var(--color-text); text-align: center; justify-content: flex-start;">
                        <div class="bento-icon" style="margin: 0 auto 1.5rem;"><i data-lucide="user"></i></div>
                        <h3 style="color: var(--color-text); font-size: 1.75rem;">Personal</h3>
                        <div style="font-size: 3rem; font-weight: 900; color: var(--color-primary); margin: 1.5rem 0;">100 KES<span style="font-size: 1.2rem; color: #71717A; font-weight: 500;">/use</span></div>
                        <ul style="list-style: none; text-align: left; margin-bottom: 2.5rem; color: var(--color-text); display: flex; flex-direction: column; gap: 0.75rem;">
                            <li style="display: flex; gap: 10px; align-items: center;"><i data-lucide="check-circle" style="width: 18px; color: var(--color-primary);"></i> Single PIN Check</li>
                            <li style="display: flex; gap: 10px; align-items: center;"><i data-lucide="check-circle" style="width: 18px; color: var(--color-primary);"></i> 1 PDF Certificate</li>
                            <li style="display: flex; gap: 10px; align-items: center;"><i data-lucide="check-circle" style="width: 18px; color: var(--color-primary);"></i> Instant Download</li>
                        </ul>
                        <button onclick="startPayment('personal')" class="btn-primary" style="width: 100%;">Pay & Use</button>
                    </div>
                    
                    <!-- Cyber Plan -->
                    <div class="bento-card bento-large" style="background: var(--color-secondary); color: white; justify-content: flex-start;">
                        <div style="position: absolute; top: 20px; right: 20px; background: white; color: var(--color-primary); padding: 6px 16px; border-radius: 99px; font-size: 0.9rem; font-weight: 800;">POPULAR</div>
                        <div class="bento-icon" style="color: var(--color-secondary); margin-bottom: 1.5rem;"><i data-lucide="briefcase"></i></div>
                        <h3 style="font-size: 2.25rem;">Cyber Premium</h3>
                        <div style="font-size: 4rem; font-weight: 900; margin: 1rem 0;">2,500 KES<span style="font-size: 1.5rem; opacity: 0.8; font-weight: 500;">/mo</span></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <ul style="list-style: none; text-align: left; display: flex; flex-direction: column; gap: 0.75rem;">
                                <li style="display: flex; gap: 10px; align-items: center;"><i data-lucide="check" style="width: 20px;"></i> Unlimited Scans</li>
                                <li style="display: flex; gap: 10px; align-items: center;"><i data-lucide="check" style="width: 20px;"></i> Unlimited PDFs</li>
                            </ul>
                            <ul style="list-style: none; text-align: left; display: flex; flex-direction: column; gap: 0.75rem;">
                                <li style="display: flex; gap: 10px; align-items: center;"><i data-lucide="check" style="width: 20px;"></i> Priority Support</li>
                                <li style="display: flex; gap: 10px; align-items: center;"><i data-lucide="check" style="width: 20px;"></i> Batch processing</li>
                            </ul>
                        </div>
                        <button onclick="startPayment('cyber_monthly')" class="btn-primary" style="width: 100%; background: white; color: var(--color-text);">Subscribe Now</button>
                        <p style="margin-top: 1rem; font-size: 0.9rem; text-align: center; opacity: 0.9;">Weekly trial available for 800 KES</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="samples" id="samplesID">
            <span class="sample-tag" onclick="fillSample('ID', 'KE', '41789723')">KE Sample</span>
            <span class="sample-tag" onclick="fillSample('ID', 'NKE', '787528')">NKE Sample</span>
            <span class="sample-tag" onclick="fillSample('ID', 'COMP', '0000200S4304')">COMP Sample</span>
        </div>

        <div class="samples" id="samplesPIN" style="display: none;">
            <span class="sample-tag" onclick="fillSample('PIN', 'A016881319Q')">Docx PIN (A01)</span>
            <span class="sample-tag" onclick="fillSample('PIN', 'P318295670X')">Valid PIN (P)</span>
            <span class="sample-tag" onclick="fillSample('PIN', 'A744610021G')">Individual (A)</span>
            <span class="sample-tag" onclick="fillSample('PIN', 'A521040203F')">Sample (A)</span>
        </div>
    </div>
        </section>
    </main>

            <!-- End Tool Content -->
            </div> <!-- .tool-wrapper -->
        </section>
    </main>

    <footer class="fat-footer">
        <div class="footer-content">
            <div class="footer-cta">
                <h2>Ready to <br>Get Started?</h2>
                <a href="#tool" class="footer-btn">Launch App</a>
            </div>
            <div class="footer-links">
                <div style="display: flex; flex-direction: column; gap: 1rem; text-align: left;">
                    <strong>Product</strong>
                    <a href="pricing.html" class="footer-link">Pricing</a>
                    <a href="about.html" class="footer-link">About</a>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1rem; text-align: left;">
                    <strong>Company</strong>
                    <a href="about.html" class="footer-link">About Us</a>
                    <a href="contact.html" class="footer-link">Contact</a>
                </div>
            </div>
        </div>
        <div class="copyright">
            &copy; 2026 Akubrecah Technologies.
        </div>
    </footer>

    <script>
        lucide.createIcons();
    </script>

    <script src="kra_api.js"></script>
    <script src="auth.js"></script>
    <script src="shared-components.js"></script>
    <script>
        // Inject the new styled auth modal
        document.body.appendChild(createAuthModal());
        if (window.lucide) lucide.createIcons();
    </script>
    <script>
        let currentMode = 'ID';

        function switchTab(mode) {
            currentMode = mode;
            // Tabs
            document.getElementById('tabID').classList.toggle('active', mode === 'ID');
            document.getElementById('tabPIN').classList.toggle('active', mode === 'PIN');
            
            // Forms
            document.getElementById('checkerFormID').style.display = mode === 'ID' ? 'block' : 'none';
            document.getElementById('checkerFormPIN').style.display = mode === 'PIN' ? 'block' : 'none';
            
            // Samples
            document.getElementById('samplesID').style.display = mode === 'ID' ? 'flex' : 'none';
            document.getElementById('samplesPIN').style.display = mode === 'PIN' ? 'flex' : 'none';
            
            // UI Reset
            document.getElementById('errorArea').style.display = 'none';
            document.getElementById('resultsArea').style.display = 'none';
        }

        function fillSample(mode, val1, val2) {
            if (mode === 'ID') {
                document.getElementById('taxpayerType').value = val1;
                document.getElementById('taxpayerID').value = val2;
            } else {
                document.getElementById('kraPIN').value = val1;
            }
        }

        // Generic Submit Handler
        async function handleSubmission(e, mode) {
            e.preventDefault();
            
            // 1. Check Access / Credits
            const canProceed = await window.checkAccess();
            if (!canProceed) return;

            const errorArea = document.getElementById('errorArea');
            const resultsArea = document.getElementById('resultsArea');
            const btnText = document.getElementById(`btnText${mode}`);
            const loader = document.getElementById(`loader${mode}`);
            const submitBtn = document.getElementById(`submitBtn${mode}`);
            const originalText = btnText.textContent;

            errorArea.style.display = 'none';
            resultsArea.style.display = 'none';
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            loader.style.display = 'block';

            // Verifying status animation
            let dots = 0;
            const statusInt = setInterval(() => {
                dots = (dots + 1) % 4;
                btnText.textContent = 'Verifying' + '.'.repeat(dots);
                btnText.style.display = 'block';
            }, 600);

            try {
                let result;
                if (mode === 'ID') {
                    const type = document.getElementById('taxpayerType').value;
                    const id = document.getElementById('taxpayerID').value;
                    result = await window.kraClient.checkPIN(type, id);
                    
                    document.getElementById('resLabelName').textContent = 'Verified Taxpayer Name';
                    document.getElementById('resLabelInfo').textContent = 'Taxpayer PIN';
                    document.getElementById('resName').textContent = result.TaxpayerName;
                    document.getElementById('resPIN').textContent = result.TaxpayerPIN;
                    document.getElementById('extraInfoArea').style.display = 'none';
                } else {
                    const pin = document.getElementById('kraPIN').value;
                    result = await window.kraClient.checkPINByPIN(pin);
                    
                    document.getElementById('resLabelName').textContent = 'Taxpayer Name';
                    document.getElementById('resLabelInfo').textContent = 'PIN Number';
                    document.getElementById('resName').textContent = result.TaxpayerName;
                    document.getElementById('resPIN').textContent = result.TaxpayerPIN;
                    document.getElementById('resType').textContent = result.Type;
                    document.getElementById('resStatus').textContent = result.Status;
                    document.getElementById('extraInfoArea').style.display = 'block';
                }
                
                // 2. Log Usage & Deduct Credit (if Personal)
                if (currentUser && currentUser.role === 'personal') {
                    await window.SupabaseClient.credits.deduct(currentUser.id);
                    // Update local state to reflect deduction
                    currentUser.credits = Math.max(0, currentUser.credits - 1);
                    updateUI();
                }
                
                // Log the check
                await window.SupabaseClient.usage.logCheck(currentUser.id, mode, 'success');

                clearInterval(statusInt);
                resultsArea.style.display = 'block';
                resultsArea.scrollIntoView({ behavior: 'smooth' });
            } catch (err) {
                console.error("Submission Error:", err);
                clearInterval(statusInt);
                let msg = err.message;
                if (msg.includes('EAI_AGAIN') || msg.includes('fetch failed')) {
                    msg = "KRA Sandbox is temporarily unreachable. We are automatically retrying behind the scenes.";
                }
                errorArea.textContent = msg;
                errorArea.style.display = 'block';
                
                // Log failed attempt
                if (currentUser) {
                    await window.SupabaseClient.usage.logCheck(currentUser.id, mode, 'failed');
                }
            } finally {
                clearInterval(statusInt);
                submitBtn.disabled = false;
                btnText.textContent = originalText;
                btnText.style.display = 'block';
                loader.style.display = 'none';
            }
        }

        document.getElementById('checkerFormID').addEventListener('submit', (e) => handleSubmission(e, 'ID'));
        document.getElementById('checkerFormPIN').addEventListener('submit', (e) => handleSubmission(e, 'PIN'));

        // PDF Generation Logic
        const modal = document.getElementById('certModal');
        const generateCertBtn = document.getElementById('generateCertBtn');
        const certDetailsForm = document.getElementById('certDetailsForm');

        // Interactive Preview Logic
        function updateDigitalPreview() {
            // Populate Fields
            document.getElementById('data-cert-date').textContent = document.getElementById('inEffectiveDate').value;
            document.getElementById('data-pin').textContent = document.getElementById('resPIN').textContent || document.getElementById('kraPIN').value || 'A000000000X';
            
            // Handle fallback for name if resName is empty or placeholder
            const name = document.getElementById('resName').textContent;
            document.getElementById('data-name').textContent = (name && name !== '-') ? name : 'Taxpayer Name';
            document.getElementById('data-email').textContent = document.getElementById('inEmail').value;
            
            document.getElementById('data-building').textContent = document.getElementById('inBuilding').value;
            document.getElementById('data-street').textContent = document.getElementById('inStreet').value;
            document.getElementById('data-city').textContent = document.getElementById('inCity').value;
            document.getElementById('data-county').textContent = document.getElementById('inCounty').value;
            document.getElementById('data-district').textContent = document.getElementById('inDistrict').value;
            document.getElementById('data-tax-area').textContent = document.getElementById('inTaxArea').value;
            document.getElementById('data-station').textContent = document.getElementById('inStation').value;
            document.getElementById('data-box').textContent = document.getElementById('inBox').value;
            document.getElementById('data-postal').textContent = document.getElementById('inPostal').value;

            // Obligation Table
            const body = document.getElementById('data-obligations-body');
            body.innerHTML = ''; // Clear existing
            
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>1</td>
                <td>${document.getElementById('inTaxObligation').value}</td>
                <td>${document.getElementById('inEffectiveDate').value}</td>
                <td>${document.getElementById('inEffectiveTill').value}</td>
                <td>${document.getElementById('inStatus').value}</td>
            `;
            body.appendChild(tr);
        }
        
        // Add change listeners to all form inputs
        ['inEmail', 'inBuilding', 'inStreet', 'inCity', 'inCounty', 'inDistrict', 'inTaxArea', 
         'inStation', 'inBox', 'inPostal', 'inEffectiveDate', 'inLRNumber', 
         'inTaxObligation', 'inEffectiveTill', 'inStatus'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.addEventListener('input', updateDigitalPreview);
                el.addEventListener('change', updateDigitalPreview);
            }
        });

        function closeModal() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) closeModal();
        }

        // LISTENER UPDATE: Security Gating handled in auth.js
        // This event is dispatched ONLY if auth.js approves the user role/payment
        window.addEventListener('certGenerationApproved', () => {
            console.log("Certificate generation approved, opening modal...");
            updateDigitalPreview();
            modal.style.display = 'block';
        });

        certDetailsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Generating...';

            try {
                // IMPORTANT: We must capture the element BEFORE we unscale it, or clone it.
                // However, html2pdf handles scaling well if we configure it right.
                // The issue is the visually scaled-down preview might render small.
                // Solution: Clone the node, append to body, remove scale, generate, then remove.
                
                const originalElement = document.getElementById('certificate-container');
                const clone = originalElement.cloneNode(true);
                
                // Create a wrapper to holding the clone "visibly" but hidden from user
                // This prevents html2canvas from thinking it's off-screen/clipped
                const wrapper = document.createElement('div');
                wrapper.style.position = 'fixed';
                wrapper.style.top = '0';
                wrapper.style.left = '0';
                wrapper.style.zIndex = '-9999';
                // We use opacity 0 instead of display:none or off-screen
                wrapper.style.opacity = '0'; 
                wrapper.style.pointerEvents = 'none';
                
                // Reset transform on clone to ensure full resolution capture
                clone.style.transform = 'none';
                clone.style.margin = '0 auto'; // Center it in the wrapper (good practice)
                
                wrapper.appendChild(clone);
                document.body.appendChild(wrapper);

                const pin = document.getElementById('data-pin').textContent || 'CERT';
                const opt = {
                    margin: 0,
                    filename: `KRA_Certificate_${pin}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 3, 
                        useCORS: true, 
                        letterRendering: true,
                        // Ensure it captures the full height
                        scrollY: 0,
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                await html2pdf().set(opt).from(clone).save();
                
                // Cleanup
                document.body.removeChild(wrapper);

                // Success feedback
                btn.textContent = '✓ Downloaded';
                setTimeout(() => {
                    closeModal();
                    btn.textContent = originalText;
                }, 1000);
            } catch (error) {
                console.error('PDF Error:', error);
                alert('PDF Generation Error: ' + error.message);
                btn.textContent = originalText;
            } finally {
                btn.disabled = false;
            }
        });

    </script>
</body>
</html>
