<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.png">
    <title>Dashboard | AkubrecaH Technologies</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Prevent FOUC (Flash of Unauthenticated Content) */
        body { display: none; }
    </style>
    <!-- Guest Mode Enabled: Auth Guard Removed -->
    <!-- <script src="auth-guard.js"></script> -->
    <script type="module" src="supabase-client.js"></script>
    <script type="module" src="auth.js"></script>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <header class="dashboard-header">
        <div class="logo"><a href="dashboard.html"><img src="logo.png" alt="Akubrecah Entertainment" style="height: 40px;"></a></div>
        <nav class="dashboard-nav">
            <a href="dashboard.html" class="active">Dashboard</a>
        </nav>
        <div class="user-menu">
            <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">U</div>
        </div>
    </header>

    <main class="dashboard-main">
        <section class="welcome-section">
            <h1>Welcome back, <span id="userName">User</span>!</h1>
            <p>Verify KRA PINs and generate professional certificates.</p>
        </section>

        <!-- Feature Selection Cards -->
        <div class="feature-grid">
            <div class="stat-card" onclick="switchFeature('generator')" style="cursor: pointer; border: 2px solid var(--color-primary); position: relative; overflow: hidden;" id="card-generator">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="stat-icon" style="background: rgba(220, 38, 38, 0.1); color: var(--color-primary);">
                        <i data-lucide="file-check-2"></i>
                    </div>
                    <div>
                        <h3 style="font-weight: 700; margin-bottom: 0.25rem; font-size: 1.1rem;">Generate Certificate</h3>
                        <p style="font-size: 0.9rem; color: var(--color-text);">Full verification & PDF download</p>
                    </div>
                </div>
                <!-- Active Indicator -->
                <div id="indicator-generator" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: var(--color-primary);"></div>
            </div>

            <div class="stat-card" onclick="switchFeature('viewer')" style="cursor: pointer; border: 1px solid var(--color-border); position: relative; overflow: hidden;" id="card-viewer">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="stat-icon" style="background: #eff6ff; color: #3b82f6;">
                        <i data-lucide="eye"></i>
                    </div>
                    <div>
                        <h3 style="font-weight: 700; margin-bottom: 0.25rem; font-size: 1.1rem;">Quick PIN View</h3>
                        <p style="font-size: 0.9rem; color: var(--color-text);">View details without generating certificate</p>
                    </div>
                </div>
                 <!-- Active Indicator -->
                 <div id="indicator-viewer" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: #3b82f6; display: none;"></div>
            </div>
        </div>

        <!-- VIEWER SECTION (Hidden by default) -->
        <div id="viewerSection" style="display: none;">
            <div class="main-card">
                 <div class="card-header">
                    <h2><i data-lucide="search" style="width: 20px; display: inline-block; vertical-align: middle; margin-right: 8px;"></i> Quick PIN Lookup</h2>
                </div>
                <div class="card-body">
                    <div class="input-group" style="margin-bottom: 0;">
                        <div style="display: flex; width: 100%; gap: 1rem;">
                            <div class="input-wrapper" style="flex: 1; position: relative;">
                                <i data-lucide="hash" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--color-icon); width: 18px;"></i>
                                <input type="text" id="viewerPinInput" placeholder="Enter KRA PIN (e.g., A001234567Z)" style="width: 100%; padding-left: 2.8rem; height: 100%;">
                            </div>
                            <button class="btn-primary" onclick="handleQuickView()">Search</button>
                        </div>
                    </div>
                     <div id="viewerLoading" style="text-align: center; padding: 2rem; display: none;">
                        <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid var(--color-primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                        <p style="margin-top: 1rem; color: var(--color-text);">Fetching details...</p>
                    </div>
                    <div id="viewerResult" style="margin-top: 2rem; display: none;">
                         <!-- Results injected here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="generatorSection">
        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="check-circle"></i></div>
                <div class="stat-value" id="verificationCount">0</div>
                <div class="stat-label">Verifications Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="file-text"></i></div>
                <div class="stat-value" id="certCount">0</div>
                <div class="stat-label">Certificates Generated</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="coins"></i></div>
                <div class="stat-value" id="creditsLeft">5</div>
                <div class="stat-label">Credits Remaining</div>
            </div>
        </section>

        <section class="content-grid">
            <!-- Form Card -->
            <div class="main-card">
                <div class="card-header">
                    <h2>Certificate Details</h2>
                </div>
                <div class="card-body">
                    <div class="verification-status" id="verificationStatus">
                        <i data-lucide="check-circle" style="width: 16px;"></i>
                        <span id="statusMessage">PIN verified successfully!</span>
                    </div>
                    
                    <!-- Verification Section -->
                    <div class="verify-section">
                        <div class="verify-row">
                            <div class="verify-group">
                                <label>KRA PIN</label>
                                <input type="text" id="kraPin" placeholder="e.g., A012345678Z" maxlength="11">
                            </div>
                            <div class="verify-group">
                                <label>ID Number</label>
                                <input type="text" id="idNumber" placeholder="e.g., 12345678">
                            </div>
                            <button class="btn-verify" onclick="verifyAndAutofill()">
                                <i data-lucide="search" style="width: 14px;"></i>
                                Verify & Autofill
                            </button>
                        </div>
                    </div>
                    
                    <!-- Personal Details -->
                    <div class="form-section-title">Personal Details</div>
                    <div class="form-grid">
                        <div class="form-group half-width">
                            <label>Taxpayer Name *</label>
                            <input type="text" id="taxpayerName" placeholder="Full name as per KRA" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="inEmail" placeholder="email@example.com" oninput="updatePreview()">
                        </div>
                    </div>
                    
                    <!-- Address Details -->
                    <div class="form-section-title">Address Details</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Building</label>
                            <input type="text" id="inBuilding" placeholder="Building name" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Street/Road</label>
                            <input type="text" id="inStreet" placeholder="Street name" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>City/Town</label>
                            <input type="text" id="inCity" placeholder="City" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>County</label>
                            <input type="text" id="inCounty" placeholder="County" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>District</label>
                            <input type="text" id="inDistrict" placeholder="District" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>L.R. Number</label>
                            <input type="text" id="inLRNumber" placeholder="Land Reference" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>P.O. Box</label>
                            <input type="text" id="inBox" placeholder="P.O. Box" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Postal Code</label>
                            <input type="text" id="inPostal" placeholder="Postal Code" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Tax Area</label>
                            <input type="text" id="inTaxArea" placeholder="Tax Area" oninput="updatePreview()">
                        </div>
                    </div>
                    
                    <!-- Tax Details -->
                    <div class="form-section-title">Tax Details</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tax Obligation</label>
                            <input type="text" id="taxObligation" placeholder="e.g., Income Tax" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Station</label>
                            <input type="text" id="inStation" placeholder="KRA Station" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="pinStatus" onchange="updatePreview()">
                                <option value="Active">Active</option>
                                <option value="Dormant">Dormant</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Effective From</label>
                            <input type="text" id="effectiveFrom" placeholder="DD/MM/YYYY" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Effective Till</label>
                            <input type="text" id="effectiveTill" placeholder="N.A." value="N.A." oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Principal Activity</label>
                            <input type="text" id="activity" placeholder="e.g., Retail Trade" oninput="updatePreview()">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-generate" onclick="generateCertificate()">
                            <i data-lucide="download" style="width: 16px;"></i>
                            Generate PDF Certificate
                        </button>
                    </div>
                </div>
            </div>

            <!-- Certificate Preview Card -->
            <div class="main-card">
                <div class="card-header">
                    <h2>Certificate Preview</h2>
                </div>
                <div class="card-body">
                    <div class="cert-preview" id="certPreview">
                        <div class="cert-header-preview">
                            <h3>KRA PIN Verification Certificate</h3>
                            <p>Generated by AkubrecaH Technologies</p>
                        </div>
                        <div class="cert-body">
                            <div class="cert-row"><div class="cert-label">KRA PIN</div><div class="cert-value" id="previewPin">-</div></div>
                            <div class="cert-row"><div class="cert-label">Taxpayer Name</div><div class="cert-value" id="previewName">-</div></div>
                            <div class="cert-row"><div class="cert-label">Email</div><div class="cert-value" id="previewEmail">-</div></div>
                            <div class="cert-row"><div class="cert-label">Address</div><div class="cert-value" id="previewAddress">-</div></div>
                            <div class="cert-row"><div class="cert-label">City/Town</div><div class="cert-value" id="previewCity">-</div></div>
                            <div class="cert-row"><div class="cert-label">County</div><div class="cert-value" id="previewCounty">-</div></div>
                            <div class="cert-row"><div class="cert-label">P.O. Box</div><div class="cert-value" id="previewBox">-</div></div>
                            <div class="cert-row"><div class="cert-label">Tax Obligation</div><div class="cert-value" id="previewObligation">-</div></div>
                            <div class="cert-row"><div class="cert-label">Station</div><div class="cert-value" id="previewStation">-</div></div>
                            <div class="cert-row"><div class="cert-label">Status</div><div class="cert-value" id="previewStatus">-</div></div>
                            <div class="cert-row"><div class="cert-label">Effective From</div><div class="cert-value" id="previewFromDate">-</div></div>
                            <div class="cert-row"><div class="cert-label">Effective Till</div><div class="cert-value" id="previewTillDate">-</div></div>
                        </div>
                        <div class="cert-footer">
                            <p>Generated on: <span id="previewTimestamp">-</span></p>
                            <p>This certificate is for verification purposes only.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- End generatorSection -->
        </section>
    </main>

    <!-- Profile Management Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content auth-content">
            <div class="auth-header">
                <h2>Profile Settings</h2>
                <span class="close-modal" onclick="closeProfile()">&times;</span>
            </div>
            
            <form id="profileForm" class="auth-form" onsubmit="handleProfileUpdate(event)">
                <div class="profile-avatar-upload" style="margin: 0 auto 2rem; width: 80px; height: 80px; position: relative; cursor: pointer;">
                    <div id="profileAvatarPreview" class="user-avatar" style="width: 100%; height: 100%; font-size: 2rem;">A</div>
                    <div style="position: absolute; bottom: 0; right: 0; background: var(--color-primary); color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 2px solid white;">
                        <i data-lucide="camera" style="width: 14px;"></i>
                    </div>
                </div>

                <div class="form-group">
                    <label>Full Name</label>
                    <div class="input-icon-wrapper">
                        <i data-lucide="user"></i>
                        <input type="text" id="profileName" required>
                    </div>
                </div>

                <div class="form-group">
                    <label>Email Address</label>
                    <div class="input-icon-wrapper">
                        <i data-lucide="mail"></i>
                        <input type="email" id="profileEmail" disabled style="background: var(--color-background); opacity: 0.7;">
                    </div>
                </div>

                <div class="form-group">
                    <label>New Password (Optional)</label>
                    <div class="input-icon-wrapper">
                        <i data-lucide="lock"></i>
                        <input type="password" id="profilePassword" placeholder="Leave blank to keep current">
                    </div>
                </div>

                <button type="submit" id="profileSubmitBtn" class="btn-primary full-width">Save Changes</button>
            </form>
        </div>
    </div>

    <script type="module" src="supabase-client.js"></script>
    <script type="module" src="kra_api.js"></script>
    <script type="module" src="auth.js"></script>
    <script>
        // --- GUEST USER INIT ---
        (function() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) {
                const guestUser = {
                    id: 'guest-' + Date.now(),
                    email: 'guest@demo.com',
                    name: 'Guest User',
                    role: 'cyber', // Using cyber role for max privileges
                    credits: 9999,
                    loggedIn: true,
                    subscription_status: 'active'
                };
                localStorage.setItem('currentUser', JSON.stringify(guestUser));
                console.log('Guest user initialized');
            }
        })();
        // -----------------------

        lucide.createIcons();
        
        // Import helpful functions from auth.js if exposed, or define local handlers
        
        // Auth check is handled by auth-guard.js at the top of the page
        // We do not strictly check here to allow async auth.js to process OAuth hashes
        
        // Load user info for UI
        const user = JSON.parse(localStorage.getItem('currentUser'));
        
        // Update UI with user info
        if (user) {
            const name = user.name || user.email.split('@')[0];
            document.getElementById('userName').textContent = name;
            document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();
        }
        
        // Load stats from localStorage
        const stats = JSON.parse(localStorage.getItem('userStats')) || { verifications: 0, certificates: 0, credits: 5 };
        document.getElementById('verificationCount').textContent = stats.verifications;
        document.getElementById('certCount').textContent = stats.certificates;
        document.getElementById('creditsLeft').textContent = stats.credits;
        
        // Update preview in real-time
        function updatePreview() {
            document.getElementById('previewPin').textContent = document.getElementById('kraPin').value || '-';
            document.getElementById('previewName').textContent = document.getElementById('taxpayerName').value || '-';
            document.getElementById('previewEmail').textContent = document.getElementById('inEmail').value || '-';
            
            const building = document.getElementById('inBuilding').value;
            const street = document.getElementById('inStreet').value;
            document.getElementById('previewAddress').textContent = [building, street].filter(Boolean).join(', ') || '-';
            
            document.getElementById('previewCity').textContent = document.getElementById('inCity').value || '-';
            document.getElementById('previewCounty').textContent = document.getElementById('inCounty').value || '-';
            
            const box = document.getElementById('inBox').value;
            const postal = document.getElementById('inPostal').value;
            document.getElementById('previewBox').textContent = box ? `${box} - ${postal}` : '-';
            
            document.getElementById('previewObligation').textContent = document.getElementById('taxObligation').value || '-';
            document.getElementById('previewStation').textContent = document.getElementById('inStation').value || '-';
            
            const status = document.getElementById('pinStatus').value;
            const statusEl = document.getElementById('previewStatus');
            statusEl.textContent = status;
            statusEl.className = 'cert-value';
            if (status === 'Active') statusEl.classList.add('active');
            else statusEl.classList.add('inactive');
            
            document.getElementById('previewFromDate').textContent = document.getElementById('effectiveFrom').value || '-';
            document.getElementById('previewTillDate').textContent = document.getElementById('effectiveTill').value || '-';
            document.getElementById('previewTimestamp').textContent = new Date().toLocaleString();
        }
        
        // Verify & Autofill function
        async function verifyAndAutofill() {
            const pin = document.getElementById('kraPin').value.trim().toUpperCase();
            const idNum = document.getElementById('idNumber').value.trim();
            
            if (!pin && !idNum) {
                showStatus('Please enter a KRA PIN or ID Number', true);
                return;
            }
            
            showStatus('Verifying with KRA...', false, true);
            
            try {
                let result;
                
                if (window.kraClient) {
                    if (pin) {
                        result = await window.kraClient.checkPINByPIN(pin);
                    } else {
                        result = await window.kraClient.checkPIN('NATIONAL_ID', idNum);
                    }
                    
                    console.log('KRA API Result:', result);
                    
                    // Autofill form from API response
                    if (result.TaxpayerPIN) document.getElementById('kraPin').value = result.TaxpayerPIN;
                    if (result.TaxpayerName) document.getElementById('taxpayerName').value = result.TaxpayerName;
                    if (result.Type) document.getElementById('taxObligation').value = result.Type;
                    if (result.Status) document.getElementById('pinStatus').value = result.Status;
                    
                    updatePreview();
                    
                    stats.verifications++;
                    localStorage.setItem('userStats', JSON.stringify(stats));
                    document.getElementById('verificationCount').textContent = stats.verifications;
                    
                    showStatus('PIN verified! Edit any field below then generate certificate.');

                    // Log the PIN check
                    if (currentUser) {
                        try {
                            const checkType = pin ? 'PIN' : 'ID';
                            const checkValue = pin || idNum;
                            // Note: logPINCheck(userId, pinChecked, idNumber, resultStatus)
                            await window.SupabaseClient.usage.logCheck(currentUser.id, pin || 'N/A', idNum || 'N/A', 'Success');
                        } catch(e) { console.error("Log failed", e); }
                    }

                } else {
                    showStatus('API client not loaded. Please refresh.', true);
                }
            } catch (error) {
                console.error('Verification error:', error);
                
                // Log failed check
                if (currentUser) {
                     try {
                        await window.SupabaseClient.usage.logCheck(currentUser.id, pin || 'N/A', idNum || 'N/A', 'Failed: ' + error.message);
                    } catch(e) {}
                }

                showStatus('Error: ' + error.message, true);
            }
        }
        
        function showStatus(message, isError = false, isPending = false) {
            const status = document.getElementById('verificationStatus');
            const messageEl = document.getElementById('statusMessage');
            status.classList.remove('error');
            if (isError) status.classList.add('error');
            messageEl.textContent = message;
            status.classList.add('show');
            if (!isPending) setTimeout(() => status.classList.remove('show'), 5000);
        }
        
        function generateCertificate() {
            const data = {
                pin: document.getElementById('kraPin').value,
                name: document.getElementById('taxpayerName').value,
                email: document.getElementById('inEmail').value,
                building: document.getElementById('inBuilding').value,
                street: document.getElementById('inStreet').value,
                city: document.getElementById('inCity').value,
                county: document.getElementById('inCounty').value,
                district: document.getElementById('inDistrict').value,
                lrNumber: document.getElementById('inLRNumber').value,
                box: document.getElementById('inBox').value,
                postal: document.getElementById('inPostal').value,
                taxArea: document.getElementById('inTaxArea').value,
                obligation: document.getElementById('taxObligation').value,
                station: document.getElementById('inStation').value,
                status: document.getElementById('pinStatus').value,
                fromDate: document.getElementById('effectiveFrom').value,
                tillDate: document.getElementById('effectiveTill').value,
                activity: document.getElementById('activity').value
            };
            
            if (!data.name) {
                showStatus('Please enter at least the Taxpayer Name', true);
                return;
            }

            // 1. Credit Check (Enforce Limits)
            if (currentUser && currentUser.role !== 'admin') {
                if (currentUser.credits <= 0) {
                     Swal.fire({
                        icon: 'warning',
                        title: 'Insufficient Credits',
                        text: 'You have 0 credits left. Please upgrade your plan or top up to generate more certificates.',
                        confirmButtonText: 'Get Credits',
                        showCancelButton: true
                    }).then((result) => {
                        if (result.isConfirmed) {
                             // Correct ID for pricing modal
                             const pricingModal = document.getElementById('pricingModal');
                             if(pricingModal) pricingModal.classList.remove('hidden');
                        }
                    });
                    return;
                }
            }
            
            const today = new Date().toLocaleDateString('en-GB');
            
            // Original KRA Certificate Design - A4 Single Page
            const certHtml = `
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
                    
                    .kra-cert-container {
                        width: 210mm;
                        min-height: 297mm;
                        background: white;
                        padding: 20mm; /* Standard A4 margins */
                        box-sizing: border-box;
                        font-family: 'Inter', system-ui, -apple-system, sans-serif;
                        color: black;
                        display: flex;
                        flex-direction: column;
                        position: relative;
                    }
                    
                    .kra-cert-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center; /* Center aligned */
                        border-bottom: 2px solid black;
                        padding-bottom: 10px;
                        margin-bottom: 15px;
                        position: relative; /* For absolute label positioning */
                    }
                    
                    .kra-logo-section {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    
                    .kra-logo-section img {
                        height: 50px; /* Reduced from 60px */
                    }
                    
                    
                    .kra-text {
                        font-weight: 500; /* Removed bold as requested */
                        font-size: 14px; /* Reduced from 16px */
                        line-height: 1.1;
                    }
                    
                    .kra-cert-label {
                        background: #e5e7eb;
                        padding: 10px 40px;
                        font-weight: 900;
                        font-size: 18px;
                        border: 1px solid #d1d5db;
                        position: absolute;
                        left: 50%;
                        top: 50%;
                        transform: translate(-50%, -50%); /* Center perfectly */
                    }
                    
                    .kra-contact-info {
                        text-align: right;
                        font-size: 9px;
                        line-height: 1.4;
                    }
                    
                    .kra-date-pin-section {
                        display: flex;
                        justify-content: flex-end;
                        margin-bottom: 20px;
                    }
                    
                    .kra-date-pin-box {
                        text-align: right;
                        line-height: 1.5;
                    }
                    
                    .kra-cert-date {
                        font-size: 11px;
                    }
                    
                    .kra-pin-label {
                        font-weight: 700;
                        font-size: 12px;
                        margin-top: 5px;
                    }
                    
                    .kra-pin-value {
                        font-weight: 500;
                        font-size: 11px;
                    }
                    
                    .kra-intro-text {
                        text-align: center;
                        font-size: 11px;
                        margin-bottom: 20px;
                    }
                    
                    .kra-section-title {
                        text-align: center;
                        font-weight: 700;
                        font-size: 13px;
                        margin-bottom: 10px;
                    }
                    
                    .kra-cert-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 20px;
                        font-size: 11px;
                    }
                    
                    .kra-cert-table th,
                    .kra-cert-table td {
                        border: 1px solid black;
                        padding: 3px 6px;
                        text-align: left;
                    }
                    
                    .kra-cert-table .bg-grey {
                        font-weight: 700;
                        width: 30%;
                    }
                    
                    .kra-obligation-table th,
                    .kra-obligation-table td {
                        text-align: center;
                        vertical-align: middle;
                        font-size: 9px;
                        padding: 2px 4px;
                    }
                    
                    .kra-obligation-table thead th {
                        font-weight: 700;
                    }
                    
                    .kra-footer-text {
                        font-size: 10px;
                        line-height: 1.5;
                        margin-top: auto;
                        padding-top: 20px;
                    }
                    
                    .kra-disclaimer {
                        border-top: 1px solid black;
                        padding-top: 5px;
                        margin-top: 30px;
                        font-weight: 700;
                        font-size: 10px;
                    }
                </style>
                
                <div class="kra-cert-container">
                    <div class="kra-cert-header">
                        <div class="kra-logo-section">
                            <img src="image1.jpeg" alt="KRA Logo">
                        </div>
                        <div class="kra-cert-label">PIN Certificate</div>
                        <div class="kra-contact-info">
                            <strong>For General Tax Questions<br>Contact KRA Call Centre</strong><br>
                            Tel: +254 (020) 4999 999<br>
                            Cell: +254(0711)099 999<br>
                            Email: callcentre@kra.go.ke
                        </div>
                    </div>

                    <div class="kra-date-pin-section">
                        <div class="kra-date-pin-box">
                            <div class="kra-cert-date"><strong>Certificate Date :</strong> ${today}</div>
                            <div class="kra-pin-label">Personal Identification Number</div>
                            <div class="kra-pin-value">${data.pin || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="kra-intro-text">
                        This is to certify that taxpayer shown herein has been registered with Kenya Revenue Authority
                    </div>

                    <div class="kra-section-title">Taxpayer Information</div>
                    <table class="kra-cert-table">
                        <tr>
                            <td class="bg-grey">Taxpayer Name</td>
                            <td>${data.name}</td>
                        </tr>
                        <tr>
                            <td class="bg-grey">Email Address</td>
                            <td>${data.email || 'N/A'}</td>
                        </tr>
                    </table>

                    <div class="kra-section-title">Registered Address</div>
                    <table class="kra-cert-table">
                        <tr>
                            <td><strong>L.R. Number :</strong> ${data.lrNumber || ''}</td>
                            <td><strong>Building :</strong> ${data.building || ''}</td>
                        </tr>
                        <tr>
                            <td><strong>Street/Road :</strong> ${data.street || ''}</td>
                            <td><strong>City/Town :</strong> ${data.city || ''}</td>
                        </tr>
                        <tr>
                            <td><strong>County :</strong> ${data.county || ''}</td>
                            <td><strong>District :</strong> ${data.district || ''}</td>
                        </tr>
                        <tr>
                            <td><strong>Tax Area :</strong> ${data.taxArea || ''}</td>
                            <td><strong>Station :</strong> ${data.station || ''}</td>
                        </tr>
                        <tr>
                            <td><strong>P. O. Box :</strong> ${data.box || ''}</td>
                            <td><strong>Postal Code :</strong> ${data.postal || ''}</td>
                        </tr>
                    </table>

                    <div class="kra-section-title">Tax Obligation(s) Registration</div>
                    <table class="kra-cert-table kra-obligation-table">
                        <thead>
                            <tr>
                                <th>Sr. No.</th>
                                <th>Tax Obligation(s)</th>
                                <th>Effective From Date</th>
                                <th>Effective Till</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>${data.obligation || 'Income Tax - Resident Individual'}</td>
                                <td>${data.fromDate || 'N/A'}</td>
                                <td>${data.tillDate || 'N.A.'}</td>
                                <td style="color: ${data.status === 'Active' ? 'green' : 'red'}; font-weight: 600;">${data.status}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="kra-footer-text">
                        The above PIN must appear on all your tax invoices and correspondences with Kenya Revenue Authority. 
                        Your accounting end date is 31st December as per the provisions stated in the Income Tax Act unless 
                        a change has been approved by the Commissioner-Domestic Taxes Department.
                    </div>

                    <div class="kra-disclaimer">
                        Disclaimer : This is a system generated certificate and does not require signature.
                    </div>
                </div>
            `;
            
            const element = document.createElement('div');
            element.innerHTML = certHtml;
            document.body.appendChild(element);
            
            const filename = data.pin ? `KRA_PIN_Certificate_${data.pin}.pdf` : `KRA_PIN_Certificate_${data.name.replace(/\s+/g, '_')}.pdf`;
            
            const opt = {
                margin: 0,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false, allowTaint: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: 'avoid-all' }
            };
            html2pdf().set(opt).from(element.querySelector('.kra-cert-container')).save().then(async () => {
                document.body.removeChild(element);
                
                // 2. Deduct Credit & Log Usage (Backend)
                if (currentUser) {
                    try {
                        if (currentUser.role !== 'admin') {
                            await window.SupabaseClient.credits.deduct(currentUser.id);
                            currentUser.credits = Math.max(0, currentUser.credits - 1);
                            document.getElementById('creditsLeft').textContent = currentUser.credits;
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        }
                        
                        // Log the certificate generation
                        await window.SupabaseClient.usage.logCertificate(currentUser.id, data.pin);

                    } catch (error) {
                        console.error("Usage logging failed:", error);
                    }
                }
            });
            
            stats.certificates++;
            localStorage.setItem('userStats', JSON.stringify(stats));
            document.getElementById('certCount').textContent = stats.certificates;
            showStatus('Official KRA Certificate generated and downloaded!');
        }
        
        // --- Profile Modal Functions ---
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            if (!modal) return;
            
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user) return;
            
            // Populate fields
            document.getElementById('profileName').value = user.name || user.full_name || '';
            document.getElementById('profileEmail').value = user.email || '';
            document.getElementById('profilePhone').value = user.phone || '';
            
            // Set avatar
            const avatarEl = document.getElementById('profileAvatarImg');
            if (user.avatar_url) {
                avatarEl.src = user.avatar_url;
            } else {
                avatarEl.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="%237C3AED"/><text x="50" y="65" font-size="40" fill="white" text-anchor="middle">' + (user.name || user.email || 'U').charAt(0).toUpperCase() + '</text></svg>';
            }
            
            modal.style.display = 'flex';
        }
        
        function closeProfileModal() {
            const modal = document.getElementById('profileModal');
            if (modal) modal.style.display = 'none';
        }
        
        async function saveProfile() {
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user || !user.id) return;
            
            const newName = document.getElementById('profileName').value.trim();
            const newPhone = document.getElementById('profilePhone').value.trim();
            
            try {
                Swal.fire({ title: 'Saving...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                await window.SupabaseClient.profile.update(user.id, {
                    full_name: newName,
                    name: newName,
                    phone: newPhone
                });
                
                user.name = newName;
                user.full_name = newName;
                user.phone = newPhone;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // Update UI
                document.getElementById('userName').textContent = newName || user.email.split('@')[0];
                
                Swal.fire({ icon: 'success', title: 'Profile Updated!', timer: 1500, showConfirmButton: false });
                closeProfileModal();
            } catch (e) {
                console.error('Profile update failed:', e);
                Swal.fire('Error', 'Failed to update profile: ' + e.message, 'error');
            }
        }
        
        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const user = JSON.parse(localStorage.getItem('currentUser'));
            if (!user || !user.id) return;
            
            try {
                Swal.fire({ title: 'Uploading...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                const avatarUrl = await window.SupabaseClient.storage.uploadAvatar(user.id, file);
                
                user.avatar_url = avatarUrl;
                localStorage.setItem('currentUser', JSON.stringify(user));
                
                // Update UI
                document.getElementById('profileAvatarImg').src = avatarUrl;
                document.getElementById('userAvatar').innerHTML = `<img src="${avatarUrl}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
                
                Swal.fire({ icon: 'success', title: 'Avatar Updated!', timer: 1500, showConfirmButton: false });
            } catch (e) {
                console.error('Avatar upload failed:', e);
                Swal.fire('Error', 'Failed to upload avatar: ' + e.message, 'error');
            }
        }
        
        function handleLogout() {
            Swal.fire({
                title: 'Logout?',
                text: 'Are you sure you want to sign out?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Logout'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    try {
                        await window.SupabaseClient.auth.signOut();
                    } catch (e) {
                        console.error('Logout error:', e);
                    }
                    localStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                }
            });
        }
        
        function toggleUserMenu() {
            openProfileModal();
        }
        
        updatePreview();
    </script>

    <!-- Profile Modal -->
    <div id="profileModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0; color: var(--color-text-dark);">Profile Settings</h2>
                <button onclick="closeProfileModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--color-text);">&times;</button>
            </div>
            
            <!-- Avatar -->
            <div style="text-align: center; margin-bottom: 1.5rem;">
                <div style="position: relative; display: inline-block;">
                    <img id="profileAvatarImg" src="" alt="Avatar" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--color-primary); cursor: pointer;" onclick="document.getElementById('avatarInput').click()">
                    <div style="position: absolute; bottom: 0; right: 0; background: var(--color-primary); color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer;" onclick="document.getElementById('avatarInput').click()">
                        <i data-lucide="camera" style="width: 14px;"></i>
                    </div>
                </div>
                <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                <p style="font-size: 0.85rem; color: var(--color-text); margin-top: 0.5rem;">Click to change avatar</p>
            </div>
            
            <!-- Form -->
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-text-dark);">Name</label>
                    <input type="text" id="profileName" placeholder="Your name" style="width: 100%; padding: 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 1rem;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-text-dark);">Email</label>
                    <input type="email" id="profileEmail" disabled style="width: 100%; padding: 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 1rem; background: #f5f5f5; color: #888;">
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--color-text-dark);">Phone</label>
                    <input type="tel" id="profilePhone" placeholder="+254..." style="width: 100%; padding: 12px; border: 1px solid var(--color-border); border-radius: 8px; font-size: 1rem;">
                </div>
            </div>
            
            <!-- Actions -->
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button class="btn-secondary" onclick="handleLogout()" style="flex: 1;">Logout</button>
                <button class="btn-primary" onclick="saveProfile()" style="flex: 1;">Save Changes</button>
            </div>
        </div>
    </div>
    <script>
        // Re-init lucide for modal icons
        if (window.lucide) lucide.createIcons();
    </script>
</body>
</html>
