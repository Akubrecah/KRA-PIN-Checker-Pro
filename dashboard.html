<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | AkubrecaH Technologies</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            background: #F9FAFB;
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        
        .dashboard-header {
            background: white;
            border-bottom: 1px solid var(--color-border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .dashboard-header .logo a {
            color: var(--color-text-dark);
            text-decoration: none;
            font-weight: 800;
            font-size: 1.25rem;
        }
        
        .dashboard-nav {
            display: flex;
            gap: 2rem;
            align-items: center;
        }
        
        .dashboard-nav a {
            color: var(--color-text);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .dashboard-nav a:hover,
        .dashboard-nav a.active {
            color: var(--color-primary);
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            cursor: pointer;
        }
        
        .dashboard-main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .welcome-section {
            margin-bottom: 2rem;
        }
        
        .welcome-section h1 {
            font-size: 2rem;
            color: var(--color-text-dark);
            margin-bottom: 0.5rem;
        }
        
        .welcome-section p {
            color: var(--color-text);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--color-border);
        }
        
        .stat-card .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(124, 58, 237, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--color-primary);
            margin-bottom: 1rem;
        }
        
        .stat-card .stat-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--color-text-dark);
        }
        
        .stat-card .stat-label {
            color: var(--color-text);
            font-size: 0.9rem;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 2rem;
        }
        
        .main-card {
            background: white;
            border-radius: 20px;
            border: 1px solid var(--color-border);
            overflow: hidden;
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            font-size: 1.15rem;
            color: var(--color-text-dark);
            margin: 0;
        }
        
        .card-body {
            padding: 1.5rem;
        }

        /* Verification Section */
        .verify-section {
            background: linear-gradient(135deg, #f8f4ff 0%, #ede7f6 100%);
            border: 1px solid #e0d4f7;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .verify-row {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .verify-group {
            flex: 1;
        }
        
        .verify-group label {
            display: block;
            font-weight: 600;
            color: var(--color-text-dark);
            font-size: 0.8rem;
            margin-bottom: 0.4rem;
        }
        
        .verify-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
        }
        
        .btn-verify {
            background: linear-gradient(135deg, #5FCDB8 0%, #4DB8A5 100%);
            color: #1F1B3D;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-family: inherit;
            font-size: 0.85rem;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .btn-verify:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(95, 205, 184, 0.3);
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }
        
        .form-group.full-width {
            grid-column: span 3;
        }
        
        .form-group.half-width {
            grid-column: span 2;
        }
        
        .form-group label {
            font-weight: 600;
            color: var(--color-text-dark);
            font-size: 0.8rem;
        }
        
        .form-group input,
        .form-group select {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }
        
        .form-section-title {
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--color-primary);
            margin: 1.25rem 0 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--color-border);
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
        }
        
        .btn-generate {
            background: var(--gradient-primary);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-generate:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(124, 58, 237, 0.3);
        }
        
        .verification-status {
            background: #ECFDF5;
            border: 1px solid #10B981;
            border-radius: 8px;
            padding: 0.6rem 1rem;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 8px;
            color: #065F46;
            font-size: 0.85rem;
        }
        
        .verification-status.show { display: flex; }
        .verification-status.error { background: #FEF2F2; border-color: #EF4444; color: #991B1B; }
        
        /* Certificate Preview */
        .cert-preview {
            background: #fff;
            border: 2px solid #7C3AED;
            border-radius: 12px;
            padding: 1.5rem;
            height: 100%;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }
        
        .cert-header-preview {
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #eee;
        }
        
        .cert-header-preview h3 {
            color: #7C3AED;
            margin: 0 0 0.25rem 0;
            font-size: 1.1rem;
        }
        
        .cert-header-preview p {
            color: #666;
            margin: 0;
            font-size: 0.75rem;
        }
        
        .cert-body {
            flex: 1;
        }
        
        .cert-row {
            display: flex;
            border-bottom: 1px solid #eee;
            padding: 0.5rem 0;
            font-size: 0.8rem;
        }
        
        .cert-row:last-child { border-bottom: none; }
        .cert-label { font-weight: 600; color: #333; width: 40%; }
        .cert-value { color: #666; }
        .cert-value.active { color: #10B981; font-weight: 600; }
        .cert-value.inactive { color: #EF4444; font-weight: 600; }
        
        .cert-footer {
            text-align: center;
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 2px solid #eee;
            color: #999;
            font-size: 0.65rem;
        }
        
        @media (max-width: 1200px) { .content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full-width, .form-group.half-width { grid-column: span 1; }
            .dashboard-nav { display: none; }
            .verify-row { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <header class="dashboard-header">
        <div class="logo"><a href="index.html">AkubrecaH</a></div>
        <nav class="dashboard-nav">
            <a href="dashboard.html" class="active">Dashboard</a>
            <a href="pricing.html">Pricing</a>
            <a href="about.html">About</a>
            <a href="contact.html">Contact</a>
        </nav>
        <div class="user-menu">
            <div class="user-avatar" id="userAvatar" onclick="toggleUserMenu()">U</div>
        </div>
    </header>

    <main class="dashboard-main">
        <section class="welcome-section">
            <h1>Welcome back, <span id="userName">User</span>!</h1>
            <p>Verify KRA PINs and generate professional certificates.</p>
        </section>

        <section class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="check-circle"></i></div>
                <div class="stat-value" id="verificationCount">0</div>
                <div class="stat-label">Verifications Today</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="file-text"></i></div>
                <div class="stat-value" id="certCount">0</div>
                <div class="stat-label">Certificates Generated</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i data-lucide="coins"></i></div>
                <div class="stat-value" id="creditsLeft">5</div>
                <div class="stat-label">Credits Remaining</div>
            </div>
        </section>

        <section class="content-grid">
            <!-- Form Card -->
            <div class="main-card">
                <div class="card-header">
                    <h2>Certificate Details</h2>
                </div>
                <div class="card-body">
                    <div class="verification-status" id="verificationStatus">
                        <i data-lucide="check-circle" style="width: 16px;"></i>
                        <span id="statusMessage">PIN verified successfully!</span>
                    </div>
                    
                    <!-- Verification Section -->
                    <div class="verify-section">
                        <div class="verify-row">
                            <div class="verify-group">
                                <label>KRA PIN</label>
                                <input type="text" id="kraPin" placeholder="e.g., A012345678Z" maxlength="11">
                            </div>
                            <div class="verify-group">
                                <label>ID Number</label>
                                <input type="text" id="idNumber" placeholder="e.g., 12345678">
                            </div>
                            <button class="btn-verify" onclick="verifyAndAutofill()">
                                <i data-lucide="search" style="width: 14px;"></i>
                                Verify & Autofill
                            </button>
                        </div>
                    </div>
                    
                    <!-- Personal Details -->
                    <div class="form-section-title">Personal Details</div>
                    <div class="form-grid">
                        <div class="form-group half-width">
                            <label>Taxpayer Name *</label>
                            <input type="text" id="taxpayerName" placeholder="Full name as per KRA" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Email Address</label>
                            <input type="email" id="inEmail" placeholder="email@example.com" oninput="updatePreview()">
                        </div>
                    </div>
                    
                    <!-- Address Details -->
                    <div class="form-section-title">Address Details</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Building</label>
                            <input type="text" id="inBuilding" placeholder="Building name" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Street/Road</label>
                            <input type="text" id="inStreet" placeholder="Street name" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>City/Town</label>
                            <input type="text" id="inCity" placeholder="City" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>County</label>
                            <input type="text" id="inCounty" placeholder="County" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>District</label>
                            <input type="text" id="inDistrict" placeholder="District" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>L.R. Number</label>
                            <input type="text" id="inLRNumber" placeholder="Land Reference" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>P.O. Box</label>
                            <input type="text" id="inBox" placeholder="P.O. Box" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Postal Code</label>
                            <input type="text" id="inPostal" placeholder="Postal Code" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Tax Area</label>
                            <input type="text" id="inTaxArea" placeholder="Tax Area" oninput="updatePreview()">
                        </div>
                    </div>
                    
                    <!-- Tax Details -->
                    <div class="form-section-title">Tax Details</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Tax Obligation</label>
                            <input type="text" id="taxObligation" placeholder="e.g., Income Tax" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Station</label>
                            <input type="text" id="inStation" placeholder="KRA Station" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select id="pinStatus" onchange="updatePreview()">
                                <option value="Active">Active</option>
                                <option value="Dormant">Dormant</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Effective From</label>
                            <input type="text" id="effectiveFrom" placeholder="DD/MM/YYYY" oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Effective Till</label>
                            <input type="text" id="effectiveTill" placeholder="N.A." value="N.A." oninput="updatePreview()">
                        </div>
                        <div class="form-group">
                            <label>Principal Activity</label>
                            <input type="text" id="activity" placeholder="e.g., Retail Trade" oninput="updatePreview()">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button class="btn-generate" onclick="generateCertificate()">
                            <i data-lucide="download" style="width: 16px;"></i>
                            Generate PDF Certificate
                        </button>
                    </div>
                </div>
            </div>

            <!-- Certificate Preview Card -->
            <div class="main-card">
                <div class="card-header">
                    <h2>Certificate Preview</h2>
                </div>
                <div class="card-body">
                    <div class="cert-preview" id="certPreview">
                        <div class="cert-header-preview">
                            <h3>KRA PIN Verification Certificate</h3>
                            <p>Generated by AkubrecaH Technologies</p>
                        </div>
                        <div class="cert-body">
                            <div class="cert-row"><div class="cert-label">KRA PIN</div><div class="cert-value" id="previewPin">-</div></div>
                            <div class="cert-row"><div class="cert-label">Taxpayer Name</div><div class="cert-value" id="previewName">-</div></div>
                            <div class="cert-row"><div class="cert-label">Email</div><div class="cert-value" id="previewEmail">-</div></div>
                            <div class="cert-row"><div class="cert-label">Address</div><div class="cert-value" id="previewAddress">-</div></div>
                            <div class="cert-row"><div class="cert-label">City/Town</div><div class="cert-value" id="previewCity">-</div></div>
                            <div class="cert-row"><div class="cert-label">County</div><div class="cert-value" id="previewCounty">-</div></div>
                            <div class="cert-row"><div class="cert-label">P.O. Box</div><div class="cert-value" id="previewBox">-</div></div>
                            <div class="cert-row"><div class="cert-label">Tax Obligation</div><div class="cert-value" id="previewObligation">-</div></div>
                            <div class="cert-row"><div class="cert-label">Station</div><div class="cert-value" id="previewStation">-</div></div>
                            <div class="cert-row"><div class="cert-label">Status</div><div class="cert-value" id="previewStatus">-</div></div>
                            <div class="cert-row"><div class="cert-label">Effective From</div><div class="cert-value" id="previewFromDate">-</div></div>
                            <div class="cert-row"><div class="cert-label">Effective Till</div><div class="cert-value" id="previewTillDate">-</div></div>
                        </div>
                        <div class="cert-footer">
                            <p>Generated on: <span id="previewTimestamp">-</span></p>
                            <p>This certificate is for verification purposes only.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="kra_api.js"></script>
    <script>
        lucide.createIcons();
        
        let currentUser = null;

        // Initialize and Check Auth
        async function initDashboard() {
            // Wait for Supabase
            if (!window.SupabaseClient || !window.supabase) {
                setTimeout(initDashboard, 100);
                return;
            }

            try {
                const session = await window.SupabaseClient.auth.getSession();
                if (!session) {
                    window.location.href = 'login.html';
                    return;
                }

                // Get full profile
                const profile = await window.SupabaseClient.profile.get(session.user.id);
                currentUser = { ...session.user, ...profile };
                
                // Update UI
                const name = currentUser.full_name || currentUser.email.split('@')[0];
                document.getElementById('userName').textContent = name;
                document.getElementById('userAvatar').textContent = name.charAt(0).toUpperCase();

                // Refresh credits
                document.getElementById('creditsLeft').textContent = currentUser.credits || 0;
                
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'login.html';
            }
        }

        initDashboard();
        
        // Load stats from localStorage
        const stats = JSON.parse(localStorage.getItem('userStats')) || { verifications: 0, certificates: 0, credits: 5 };
        document.getElementById('verificationCount').textContent = stats.verifications;
        document.getElementById('certCount').textContent = stats.certificates;
        document.getElementById('creditsLeft').textContent = stats.credits;
        
        // Update preview in real-time
        function updatePreview() {
            document.getElementById('previewPin').textContent = document.getElementById('kraPin').value || '-';
            document.getElementById('previewName').textContent = document.getElementById('taxpayerName').value || '-';
            document.getElementById('previewEmail').textContent = document.getElementById('inEmail').value || '-';
            
            const building = document.getElementById('inBuilding').value;
            const street = document.getElementById('inStreet').value;
            document.getElementById('previewAddress').textContent = [building, street].filter(Boolean).join(', ') || '-';
            
            document.getElementById('previewCity').textContent = document.getElementById('inCity').value || '-';
            document.getElementById('previewCounty').textContent = document.getElementById('inCounty').value || '-';
            
            const box = document.getElementById('inBox').value;
            const postal = document.getElementById('inPostal').value;
            document.getElementById('previewBox').textContent = box ? `${box} - ${postal}` : '-';
            
            document.getElementById('previewObligation').textContent = document.getElementById('taxObligation').value || '-';
            document.getElementById('previewStation').textContent = document.getElementById('inStation').value || '-';
            
            const status = document.getElementById('pinStatus').value;
            const statusEl = document.getElementById('previewStatus');
            statusEl.textContent = status;
            statusEl.className = 'cert-value';
            if (status === 'Active') statusEl.classList.add('active');
            else statusEl.classList.add('inactive');
            
            document.getElementById('previewFromDate').textContent = document.getElementById('effectiveFrom').value || '-';
            document.getElementById('previewTillDate').textContent = document.getElementById('effectiveTill').value || '-';
            document.getElementById('previewTimestamp').textContent = new Date().toLocaleString();
        }
        
        // Verify & Autofill function
        async function verifyAndAutofill() {
            const pin = document.getElementById('kraPin').value.trim().toUpperCase();
            const idNum = document.getElementById('idNumber').value.trim();
            
            if (!pin && !idNum) {
                showStatus('Please enter a KRA PIN or ID Number', true);
                return;
            }
            
            showStatus('Verifying with KRA...', false, true);
            
            try {
                let result;
                
                if (window.kraClient) {
                    if (pin) {
                        result = await window.kraClient.checkPINByPIN(pin);
                    } else {
                        result = await window.kraClient.checkPIN('NATIONAL_ID', idNum);
                    }
                    
                    console.log('KRA API Result:', result);
                    
                    // Autofill form from API response
                    if (result.TaxpayerPIN) document.getElementById('kraPin').value = result.TaxpayerPIN;
                    if (result.TaxpayerName) document.getElementById('taxpayerName').value = result.TaxpayerName;
                    if (result.Type) document.getElementById('taxObligation').value = result.Type;
                    if (result.Status) document.getElementById('pinStatus').value = result.Status;
                    
                    updatePreview();
                    
                    stats.verifications++;
                    localStorage.setItem('userStats', JSON.stringify(stats));
                    document.getElementById('verificationCount').textContent = stats.verifications;
                    
                    showStatus('PIN verified! Edit any field below then generate certificate.');
                } else {
                    showStatus('API client not loaded. Please refresh.', true);
                }
            } catch (error) {
                console.error('Verification error:', error);
                showStatus('Error: ' + error.message, true);
            }
        }
        
        function showStatus(message, isError = false, isPending = false) {
            const status = document.getElementById('verificationStatus');
            const messageEl = document.getElementById('statusMessage');
            status.classList.remove('error');
            if (isError) status.classList.add('error');
            messageEl.textContent = message;
            status.classList.add('show');
            if (!isPending) setTimeout(() => status.classList.remove('show'), 5000);
        }
        
        function generateCertificate() {
            const data = {
                pin: document.getElementById('kraPin').value,
                name: document.getElementById('taxpayerName').value,
                email: document.getElementById('inEmail').value,
                building: document.getElementById('inBuilding').value,
                street: document.getElementById('inStreet').value,
                city: document.getElementById('inCity').value,
                county: document.getElementById('inCounty').value,
                district: document.getElementById('inDistrict').value,
                lrNumber: document.getElementById('inLRNumber').value,
                box: document.getElementById('inBox').value,
                postal: document.getElementById('inPostal').value,
                taxArea: document.getElementById('inTaxArea').value,
                obligation: document.getElementById('taxObligation').value,
                station: document.getElementById('inStation').value,
                status: document.getElementById('pinStatus').value,
                fromDate: document.getElementById('effectiveFrom').value,
                tillDate: document.getElementById('effectiveTill').value,
                activity: document.getElementById('activity').value
            };
            
            if (!data.name) {
                showStatus('Please enter at least the Taxpayer Name', true);
                return;
            }
            
            const today = new Date().toLocaleDateString('en-GB');
            
            // Original KRA Certificate Design - A4 Single Page
            const certHtml = `
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
                    
                    .kra-cert-container {
                        width: 210mm;
                        height: 297mm;
                        max-height: 297mm;
                        background: white;
                        padding: 1.8cm; /* Reduced slightly to ensure single page fit & footer visibility */
                        box-sizing: border-box;
                        font-family: 'Inter', system-ui, -apple-system, sans-serif;
                        color: black;
                        display: flex;
                        flex-direction: column;
                        position: relative;
                        overflow: hidden; /* Strict overflow hiding */
                    }
                    
                    .kra-cert-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center; /* Fixed alignment */
                        border-bottom: 2px solid black;
                        padding-bottom: 10px;
                        margin-bottom: 15px;
                    }
                    
                    .kra-logo-section {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }
                    
                    .kra-logo-section img {
                        height: 60px;
                    }
                    
                    .kra-text {
                        font-weight: 500; /* Removed bold */
                        font-size: 16px;
                        line-height: 1.1;
                    }
                    
                    /* Centered Title with Absolute Position */
                    .kra-cert-label {
                        background: #e5e7eb;
                        padding: 10px 40px;
                        font-weight: 900;
                        font-size: 20px;
                        border: 1px solid #d1d5db;
                        position: absolute;
                        left: 50%;
                        transform: translateX(-50%);
                        top: 2.2cm; /* Specific vertical alignment */
                    }
                    
                    .kra-contact-info {
                        text-align: right;
                        font-size: 9px;
                        line-height: 1.4;
                    }
                    
                    .kra-date-pin-section {
                        display: flex;
                        justify-content: flex-end;
                        margin-bottom: 20px;
                    }
                    
                    .kra-date-pin-box {
                        text-align: right;
                        line-height: 1.5;
                    }
                    
                    .kra-cert-date {
                        font-size: 11px;
                    }
                    
                    .kra-pin-label {
                        font-weight: 700;
                        font-size: 12px;
                        margin-top: 5px;
                    }
                    
                    .kra-pin-value {
                        font-weight: 500;
                        font-size: 11px;
                    }
                    
                    .kra-intro-text {
                        text-align: center;
                        font-size: 11px;
                        margin-bottom: 20px;
                    }
                    
                    .kra-section-title {
                        text-align: center;
                        font-weight: 700;
                        font-size: 13px;
                        margin-bottom: 10px;
                    }
                    
                    .kra-cert-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 20px;
                        font-size: 11px;
                    }
                    
                    .kra-cert-table th,
                    .kra-cert-table td {
                        border: 1px solid black;
                        padding: 3px 6px;
                        text-align: left;
                    }
                    
                    .kra-cert-table .bg-grey {
                        font-weight: 700;
                        width: 30%;
                    }
                    
                    .kra-obligation-table th,
                    .kra-obligation-table td {
                        text-align: center;
                        vertical-align: middle;
                        font-size: 9px;
                        padding: 2px 4px;
                    }
                    
                    .kra-obligation-table thead th {
                        font-weight: 700;
                    }
                    
                    .kra-footer-text {
                        font-size: 10px;
                        line-height: 1.4;
                        margin-top: auto;
                        padding-top: 15px;
                    }
                    
                    .kra-disclaimer {
                        border-top: 1px solid black;
                        padding-top: 5px;
                        margin-top: 15px; /* Reduced margin */
                        font-weight: 700;
                        font-size: 10px;
                    }
                </style>
                
                <div class="kra-cert-container">
                    <div class="kra-cert-header">
                        <div class="kra-logo-section">
                            <img src="image1.jpeg" alt="KRA Logo">
                            <div class="kra-text">KENYA REVENUE<br>AUTHORITY</div>
                        </div>
                        <div class="kra-cert-label">PIN Certificate</div>
                        <div class="kra-contact-info">
                            <strong>For General Tax Questions<br>Contact KRA Call Centre</strong><br>
                            Tel: +254 (020) 4999 999<br>
                            Cell: +254(0711)099 999<br>
                            Email: callcentre@kra.go.ke
                        </div>
                    </div>

                    <div class="kra-date-pin-section">
                        <div class="kra-date-pin-box">
                            <div class="kra-cert-date"><strong>Certificate Date :</strong> ${today}</div>
                            <div class="kra-pin-label">Personal Identification Number</div>
                            <div class="kra-pin-value">${data.pin || 'N/A'}</div>
                        </div>
                    </div>

                    <div class="kra-intro-text">
                        This is to certify that taxpayer shown herein has been registered with Kenya Revenue Authority
                    </div>

                    <div class="kra-section-title">Taxpayer Information</div>
                    <table class="kra-cert-table">
                        <tr>
                            <td class="bg-grey">Taxpayer Name</td>
                            <td>${data.name}</td>
                        </tr>
                        <tr>
                            <td class="bg-grey">Email Address</td>
                            <td>${data.email || 'N/A'}</td>
                        </tr>
                    </table>

                    <div class="kra-section-title">Registered Address</div>
                    <table class="kra-cert-table">
                        <tr>
                            <td><strong>L.R. Number :</strong> ${data.lrNumber || ''}</td>
                            <td><strong>Building :</strong> ${data.building || ''}</td>
                        </tr>
                        <tr>
                            <td><strong>Street/Road :</strong> ${data.street || ''}</td>
                            <td><strong>City/Town :</strong> ${data.city || ''}</td>
                        </tr>
                        <tr>
                            <td><strong>County :</strong> ${data.county || ''}</td>
                            <td><strong>District :</strong> ${data.district || ''}</td>
                        </tr>
                        <tr>
                            <td><strong>Tax Area :</strong> ${data.taxArea || ''}</td>
                            <td><strong>Station :</strong> ${data.station || ''}</td>
                        </tr>
                        <tr>
                            <td><strong>P. O. Box :</strong> ${data.box || ''}</td>
                            <td><strong>Postal Code :</strong> ${data.postal || ''}</td>
                        </tr>
                    </table>

                    <div class="kra-section-title">Tax Obligation(s) Registration</div>
                    <table class="kra-cert-table kra-obligation-table">
                        <thead>
                            <tr>
                                <th>Sr. No.</th>
                                <th>Tax Obligation(s)</th>
                                <th>Effective From Date</th>
                                <th>Effective Till</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1</td>
                                <td>${data.obligation || 'Income Tax - Resident Individual'}</td>
                                <td>${data.fromDate || 'N/A'}</td>
                                <td>${data.tillDate || 'N.A.'}</td>
                                <td style="color: ${data.status === 'Active' ? 'green' : 'red'}; font-weight: 600;">${data.status}</td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="kra-footer-text">
                        The above PIN must appear on all your tax invoices and correspondences with Kenya Revenue Authority. 
                        Your accounting end date is 31st December as per the provisions stated in the Income Tax Act unless 
                        a change has been approved by the Commissioner-Domestic Taxes Department.
                    </div>

                    <div class="kra-disclaimer">
                        Disclaimer : This is a system generated certificate and does not require signature.
                    </div>
                </div>
            `;
            
            // Create wrapper for proper PDF rendering
            const wrapper = document.createElement('div');
            wrapper.style.position = 'fixed';
            wrapper.style.top = '0';
            wrapper.style.left = '0';
            wrapper.style.zIndex = '-9999';
            wrapper.style.opacity = '0';
            wrapper.style.pointerEvents = 'none';
            wrapper.innerHTML = certHtml;
            document.body.appendChild(wrapper);
            
            const certElement = wrapper.querySelector('.kra-cert-container');
            const filename = data.pin ? `KRA_PIN_Certificate_${data.pin}.pdf` : `KRA_PIN_Certificate_${data.name.replace(/\s+/g, '_')}.pdf`;
            
            const opt = {
                margin: 0,
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    letterRendering: true,
                    scrollY: 0,
                    logging: false,
                    windowWidth: 794, // A4 pixel width at 96 DPI
                    windowHeight: 1123,
                    height: 1123
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            html2pdf().set(opt).from(certElement).save().then(() => {
                document.body.removeChild(wrapper);
            });
            
            stats.certificates++;
            localStorage.setItem('userStats', JSON.stringify(stats));
            document.getElementById('certCount').textContent = stats.certificates;
            showStatus('Official KRA Certificate generated and downloaded!');
        }
        
        async function toggleUserMenu() {
            if (confirm('Logout?')) {
                await window.SupabaseClient.auth.signOut();
                localStorage.removeItem('currentUser'); // optional cleaning
                window.location.href = 'login.html';
            }
        }
        
        updatePreview();
    </script>
</body>
</html>
